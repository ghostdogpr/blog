<!DOCTYPE html><html lang="en"> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="generator" content="Astro v5.13.7"><!-- Favicons --><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="apple-mobile-web-app-title" content="Pierre Ricadat's Tech Blog"><!-- Canonical URL --><link rel="canonical" href="https://blog.pierre-ricadat.com/debugging-session-1-zio-logging-quill/"><!-- Primary Meta Tags --><title>Debugging session #1: zio-logging &amp; quill</title><meta name="title" content="Debugging session #1: zio-logging &#38; quill"><meta name="description" content="In this new series of posts, I will share walkthroughs of debugging sessions I had to do at work to solve real-life problems, in the hope that both the proce...
"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://blog.pierre-ricadat.com/debugging-session-1-zio-logging-quill/"><meta property="og:title" content="Debugging session #1: zio-logging &#38; quill"><meta property="og:description" content="In this new series of posts, I will share walkthroughs of debugging sessions I had to do at work to solve real-life problems, in the hope that both the proce...
"><meta property="og:image" content="https://blog.pierre-ricadat.com/saral-og.jpg"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://blog.pierre-ricadat.com/debugging-session-1-zio-logging-quill/"><meta property="twitter:title" content="Debugging session #1: zio-logging &#38; quill"><meta property="twitter:description" content="In this new series of posts, I will share walkthroughs of debugging sessions I had to do at work to solve real-life problems, in the hope that both the proce...
"><meta property="twitter:image" content="https://blog.pierre-ricadat.com/saral-og.jpg"><!-- RSS Auto-discovery --><link rel="alternate" type="application/rss+xml" title="Pierre Ricadat's Tech Blog RSS Feed" href="https://blog.pierre-ricadat.com/rss.xml"><link rel="stylesheet" href="/_astro/_slug_.DSRIcTml.css"><script>!(function(w,p,f,c){if(!window.crossOriginIsolated && !navigator.serviceWorker) return;c=w[p]=Object.assign(w[p]||{},{"lib":"/~partytown/","debug":false});c[f]=(c[f]||[]).concat(["dataLayer.push"])})(window,'partytown','forward');/* Partytown 0.11.2 - MIT QwikDev */
const t={preserveBehavior:!1},e=e=>{if("string"==typeof e)return[e,t];const[n,r=t]=e;return[n,{...t,...r}]},n=Object.freeze((t=>{const e=new Set;let n=[];do{Object.getOwnPropertyNames(n).forEach((t=>{"function"==typeof n[t]&&e.add(t)}))}while((n=Object.getPrototypeOf(n))!==Object.prototype);return Array.from(e)})());!function(t,r,o,i,a,s,c,l,d,p,u=t,f){function h(){f||(f=1,"/"==(c=(s.lib||"/~partytown/")+(s.debug?"debug/":""))[0]&&(d=r.querySelectorAll('script[type="text/partytown"]'),i!=t?i.dispatchEvent(new CustomEvent("pt1",{detail:t})):(l=setTimeout(v,(null==s?void 0:s.fallbackTimeout)||1e4),r.addEventListener("pt0",w),a?y(1):o.serviceWorker?o.serviceWorker.register(c+(s.swPath||"partytown-sw.js"),{scope:c}).then((function(t){t.active?y():t.installing&&t.installing.addEventListener("statechange",(function(t){"activated"==t.target.state&&y()}))}),console.error):v())))}function y(e){p=r.createElement(e?"script":"iframe"),t._pttab=Date.now(),e||(p.style.display="block",p.style.width="0",p.style.height="0",p.style.border="0",p.style.visibility="hidden",p.setAttribute("aria-hidden",!0)),p.src=c+"partytown-"+(e?"atomics.js?v=0.11.2":"sandbox-sw.html?"+t._pttab),r.querySelector(s.sandboxParent||"body").appendChild(p)}function v(n,o){for(w(),i==t&&(s.forward||[]).map((function(n){const[r]=e(n);delete t[r.split(".")[0]]})),n=0;n<d.length;n++)(o=r.createElement("script")).innerHTML=d[n].innerHTML,o.nonce=s.nonce,r.head.appendChild(o);p&&p.parentNode.removeChild(p)}function w(){clearTimeout(l)}s=t.partytown||{},i==t&&(s.forward||[]).map((function(r){const[o,{preserveBehavior:i}]=e(r);u=t,o.split(".").map((function(e,r,o){var a;u=u[o[r]]=r+1<o.length?u[o[r]]||(a=o[r+1],n.includes(a)?[]:{}):(()=>{let e=null;if(i){const{methodOrProperty:n,thisObject:r}=((t,e)=>{let n=t;for(let t=0;t<e.length-1;t+=1)n=n[e[t]];return{thisObject:n,methodOrProperty:e.length>0?n[e[e.length-1]]:void 0}})(t,o);"function"==typeof n&&(e=(...t)=>n.apply(r,...t))}return function(){let n;return e&&(n=e(arguments)),(t._ptf=t._ptf||[]).push(o,arguments),n}})()}))})),"complete"==r.readyState?h():(t.addEventListener("DOMContentLoaded",h),t.addEventListener("load",h))}(window,document,navigator,top,window.crossOriginIsolated);;(e=>{e.addEventListener("astro:before-swap",e=>{let r=document.body.querySelector("iframe[src*='/~partytown/']");if(r)e.newDocument.body.append(r)})})(document);</script></head> <body class="text-foreground bg-background font-light dark:text-foreground-dark dark:bg-background-dark transition-colors"> <header class="fixed top-0 w-full z-40 bg-background dark:bg-background-dark"> <nav class=""> <div class="app-container flex justify-between items-center py-5"> <a href="/" aria-label="Home"> <svg width="36" height="36" viewBox="0 0 36 36" fill="none">
  <rect width="36" height="36" rx="8" fill="currentColor" opacity="0.1" />
  <text x="18" y="25" font-family="system-ui, -apple-system, sans-serif" font-size="18" font-weight="700" fill="currentColor" text-anchor="middle">PR</text>
</svg> </a> <div class="gap-8 hidden md:flex items-center"> <a href="/" class="text-lg" target="_self" data-astro-cid-rieiwi5x> Blog </a> <a href="https://github.com/sponsors/ghostdogpr" class="text-lg" target="_blank" data-astro-cid-rieiwi5x> Sponsor </a>  <div class="border-[1px] border-foreground dark:border-foreground-dark rounded-full flex justify-center items-center text-foreground dark:text-foreground-dark [&#38;>*:hover]:brightness-75 md:opacity-80 [&#38;>*]:cursor-pointer" data-astro-cid-lgn464si> <button data-theme="theme-auto" aria-label="Auto Theme" title="Set theme to follow system preference" class="theme-button theme-auto" data-astro-cid-lgn464si> <svg width="1em" height="1em" aria-hidden="true" data-astro-cid-lgn464si="true" class="duration-0 text-2xl md:text-xl" data-icon="mdi:brightness-auto">   <symbol id="ai:mdi:brightness-auto" viewBox="0 0 24 24"><path fill="currentColor" d="m14.3 16l-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69L8.69 4H4v4.69L.69 12L4 15.31V20h4.69L12 23.31L15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"/></symbol><use href="#ai:mdi:brightness-auto"></use>  </svg> </button> <button data-theme="theme-light" aria-label="Light Theme" title="Set theme to light" class="theme-button theme-light" data-astro-cid-lgn464si> <svg width="1em" height="1em" aria-hidden="true" data-astro-cid-lgn464si="true" class="duration-0 text-2xl md:text-xl" data-icon="mdi:white-balance-sunny">   <symbol id="ai:mdi:white-balance-sunny" viewBox="0 0 24 24"><path fill="currentColor" d="m3.55 19.09l1.41 1.41l1.8-1.79l-1.42-1.42M12 6c-3.31 0-6 2.69-6 6s2.69 6 6 6s6-2.69 6-6c0-3.32-2.69-6-6-6m8 7h3v-2h-3m-2.76 7.71l1.8 1.79l1.41-1.41l-1.79-1.8M20.45 5l-1.41-1.4l-1.8 1.79l1.42 1.42M13 1h-2v3h2M6.76 5.39L4.96 3.6L3.55 5l1.79 1.81zM1 13h3v-2H1m12 9h-2v3h2"/></symbol><use href="#ai:mdi:white-balance-sunny"></use>  </svg> </button> <button data-theme="theme-dark" aria-label="Dark Theme" title="Set theme to dark" class="theme-button theme-dark" data-astro-cid-lgn464si> <svg width="1em" height="1em" aria-hidden="true" data-astro-cid-lgn464si="true" class="duration-0 text-2xl md:text-xl" data-icon="mdi:moon-and-stars">   <symbol id="ai:mdi:moon-and-stars" viewBox="0 0 24 24"><path fill="currentColor" d="m17.75 4.09l-2.53 1.94l.91 3.06l-2.63-1.81l-2.63 1.81l.91-3.06l-2.53-1.94L12.44 4l1.06-3l1.06 3zm3.5 6.91l-1.64 1.25l.59 1.98l-1.7-1.17l-1.7 1.17l.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85c-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14c.4-.4.82-.76 1.27-1.08c.75-.53 1.93.36 1.85 1.19c-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82c-2.81 3.14-2.7 7.96.31 10.98c3.02 3.01 7.84 3.12 10.98.31"/></symbol><use href="#ai:mdi:moon-and-stars"></use>  </svg> </button> </div>  </div> <button class="md:hidden cursor-pointer" id="nav-open-btn" aria-label="Open navigation menu" title="Open navigation menu"> <svg width="32" height="32" aria-hidden="true" data-icon="mdi:menu">   <symbol id="ai:mdi:menu" viewBox="0 0 24 24"><path fill="currentColor" d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></symbol><use href="#ai:mdi:menu"></use>  </svg> </button> <!-- Mobile nav --> <div class="translate-x-full md:hidden fixed top-0 right-0 bg-background dark:bg-background-dark h-screen w-5/6 px-8 py-6 transition-transform z-40 border-l-[1px] border-background" id="mobile-menu"> <button id="nav-close-btn" class="ml-auto block cursor-pointer" aria-label="Close navigation menu" title="Close navigation menu"> <svg width="32" height="32" aria-hidden="true" data-icon="mdi:close">   <symbol id="ai:mdi:close" viewBox="0 0 24 24"><path fill="currentColor" d="M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12z"/></symbol><use href="#ai:mdi:close"></use>  </svg> </button> <div class="flex flex-col h-full items-start gap-8 pt-16"> <a href="/" class="text-4xl font-light" target="_self" data-astro-cid-rieiwi5x> Blog </a> <a href="https://github.com/sponsors/ghostdogpr" class="text-4xl font-light" target="_blank" data-astro-cid-rieiwi5x> Sponsor </a>  <div class="mt-4 border-[1px] border-foreground dark:border-foreground-dark rounded-full flex justify-center items-center text-foreground dark:text-foreground-dark [&#38;>*:hover]:brightness-75 md:opacity-80 [&#38;>*]:cursor-pointer" data-astro-cid-lgn464si> <button data-theme="theme-auto" aria-label="Auto Theme" title="Set theme to follow system preference" class="theme-button theme-auto" data-astro-cid-lgn464si> <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" data-astro-cid-lgn464si="true" class="duration-0 text-2xl md:text-xl" data-icon="mdi:brightness-auto">   <use href="#ai:mdi:brightness-auto"></use>  </svg> </button> <button data-theme="theme-light" aria-label="Light Theme" title="Set theme to light" class="theme-button theme-light" data-astro-cid-lgn464si> <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" data-astro-cid-lgn464si="true" class="duration-0 text-2xl md:text-xl" data-icon="mdi:white-balance-sunny">   <use href="#ai:mdi:white-balance-sunny"></use>  </svg> </button> <button data-theme="theme-dark" aria-label="Dark Theme" title="Set theme to dark" class="theme-button theme-dark" data-astro-cid-lgn464si> <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" data-astro-cid-lgn464si="true" class="duration-0 text-2xl md:text-xl" data-icon="mdi:moon-and-stars">   <use href="#ai:mdi:moon-and-stars"></use>  </svg> </button> </div>  </div> </div> </div> </nav> <script type="module">function e(){document.querySelector("#mobile-menu")?.classList.toggle("mobile-nav-open")}document.querySelector("#nav-open-btn")?.addEventListener("click",e);document.querySelector("#nav-close-btn")?.addEventListener("click",e);</script> </header> <script>
	function reComputeTheme() {
		if (
			localStorage.theme === 'dark' ||
			(!('theme' in localStorage) &&
				window.matchMedia('(prefers-color-scheme: dark)').matches)
		) {
			document.documentElement.classList.add('dark')
		} else {
			document.documentElement.classList.remove('dark')
		}

		const theme = localStorage.theme || 'auto'
		document
			.querySelectorAll(`[data-theme="theme-${theme}"]`)
			.forEach((el) => el.classList.add('active'))
	}

	function addThemeEventListeners() {
		themeButtons = document.querySelectorAll('.theme-button')
		themeButtons.forEach((button) => {
			button.addEventListener('click', () => {
				themeButtons.forEach((btn) => btn.classList.remove('active'))
				button.classList.add('active')
				if (button.dataset.theme === 'theme-auto') {
					localStorage.removeItem('theme')
					reComputeTheme()
				} else {
					localStorage.theme = button.dataset.theme.replace('theme-', '')
					document.documentElement.classList.toggle(
						'dark',
						button.dataset.theme === 'theme-dark'
					)
				}
			})
		})
	}

	// Set active class on OS theme change
	window
		.matchMedia('(prefers-color-scheme: dark)')
		.addEventListener('change', (_e) => {
			reComputeTheme()
		})

	// run recomputeTheme when screen crosses 768px
	window.matchMedia('(min-width: 768px)').addEventListener('change', (_e) => {
		addThemeEventListeners()
		reComputeTheme()
	})

	reComputeTheme()

	// Run on page load
	window.addEventListener('DOMContentLoaded', () => {
		addThemeEventListeners()
		reComputeTheme()
	})
</script>  <main> <article> <div class="app-container flex flex-col lg:flex-row-reverse justify-between gap-8 py-24 relative"> <div class="md:w-1/4 relative"> <div class="sticky top-0 md:top-28 hidden lg:block"> <div></div> </div> </div> <div class="grow w-full md:max-w-[75ch]"> <div> <h1 class="text-4xl sm:text-5xl leading-snug pt-12 font-bold"> Debugging session #1: zio-logging &amp; quill </h1> <div class="text-lg flex items-center gap-4 flex-wrap py-8"> <!-- Publish date --> <span> <svg width="1em" height="1em" class="inline-block text-primary dark:text-primary-dark" data-icon="mdi:calendar-month-outline">   <symbol id="ai:mdi:calendar-month-outline" viewBox="0 0 24 24"><path fill="currentColor" d="M7 11h2v2H7zm14-6v14c0 1.11-.89 2-2 2H5a2 2 0 0 1-2-2V5c0-1.1.9-2 2-2h1V1h2v2h8V1h2v2h1a2 2 0 0 1 2 2M5 7h14V5H5zm14 12V9H5v10zm-4-6v-2h2v2zm-4 0v-2h2v2zm-4 2h2v2H7zm8 2v-2h2v2zm-4 0v-2h2v2z"/></symbol><use href="#ai:mdi:calendar-month-outline"></use>  </svg> <time datetime="2024-02-11T00:00:00.000Z"> 11 Feb 2024 </time> </span> <!-- Updated date -->  <!-- Read time --> <span> <svg width="1em" height="1em" class="inline-block text-primary dark:text-primary-dark" data-icon="mdi:clock-time-four-outline">   <symbol id="ai:mdi:clock-time-four-outline" viewBox="0 0 24 24"><path fill="currentColor" d="M12 20c4.4 0 8-3.6 8-8s-3.6-8-8-8s-8 3.6-8 8s3.6 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10S2 17.5 2 12S6.5 2 12 2m5 11.9l-.7 1.3l-5.3-2.9V7h1.5v4.4z"/></symbol><use href="#ai:mdi:clock-time-four-outline"></use>  </svg> 6 min read </span> </div>  <img src="/_astro/cover.DM7k9o3U_Z1o1C0S.webp" alt="Debugging session #1: zio-logging &#38; quill" loading="lazy" decoding="async" fetchpriority="auto" width="853" height="480" class="rounded-lg mb-8">  </div> <div class="prose prose-neutral prose-lg md:prose-xl dark:prose-invert prose-img:rounded-xl prose-figure:text-center prose-img:mx-auto">  <p>In this new series of posts, I will share walkthroughs of debugging sessions I had to do at work to solve real-life problems, in the hope that both the process and the lessons learned will be useful to others working in the Scala ecosystem.</p>
<h3 id="the-problem">The problem</h3>
<p>While we were load testing a new service that will be deployed to production soon, I noticed something odd in the profiler (we use the fantastic <a href="https://www.datadoghq.com/product/code-profiling/">Datadog Continuous Profiler</a> both in prod and load test environments; it is always on with minimal performance impact).</p>
<figure class="rehype-figure-title"><img  loading="lazy" decoding="async" fetchpriority="auto" width="4004" height="1396" src="/_astro/image-1.CHBCjtfY_1Io9pj.webp" ></figure>
<p>It is spending a lot of time in a function called <code>CastleState.toString()</code>. <code>CastleState</code> is a pretty large domain object that gets written to the database quite often, so it makes sense that computing its <code>toString</code> would be pretty slow. However, there is no call to <code>toString</code> in our code at all. What’s happening then?</p>
<h3 id="the-investigation">The investigation</h3>
<p>Let’s look a little closer to see where that call comes from.</p>
<figure class="rehype-figure-title"><img  loading="lazy" decoding="async" fetchpriority="auto" width="2070" height="790" src="/_astro/image-2.cvCsXlEj_Z21MhGq.webp" ></figure>
<p>The call originates from <code>ContextLogger.logQuery</code>, which belongs to the <a href="https://github.com/zio/zio-quill">Quill</a> library that we use for all database access. Let’s examine the <code>logQuery</code> function in detail (<a href="https://github.com/zio/zio-quill/blob/b4b7acfb06e114a61e3d9f3ecd43acecae058c81/quill-engine/src/main/scala/io/getquill/util/ContextLogger.scala#L28">here’s the code on GitHub</a>):</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="scala"><code><span class="line"><span style="color:#F97583">def</span><span style="color:#B392F0"> logQuery</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">query</span><span style="color:#E1E4E8">: </span><span style="color:#B392F0">String</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">params</span><span style="color:#E1E4E8">: </span><span style="color:#B392F0">Seq</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">Any</span><span style="color:#E1E4E8">])</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Unit</span><span style="color:#F97583"> =</span></span>
<span class="line"><span style="color:#F97583">  if</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">!</span><span style="color:#E1E4E8">bindsEnabled </span><span style="color:#F97583">||</span><span style="color:#E1E4E8"> params.isEmpty) underlying.debug(query.trimTooLong)</span></span>
<span class="line"><span style="color:#F97583">  else</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">    underlying.debug(</span><span style="color:#9ECBFF">"{} - binds: {}"</span><span style="color:#E1E4E8">, query.trimTooLong, prepareParams(params))</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span></code></pre>
<p>If there are query parameters (<code>params</code>), the code checks the value of <code>bindsEnabled</code>: if true, it logs all parameters (<code>prepareParams</code> is the function that actually calls <code>toString</code>); otherwise, it only logs the SQL query without its parameters.</p>
<p>A quick look at the definition of <code>bindsEnabled</code>:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="scala"><code><span class="line"><span style="color:#F97583">private</span><span style="color:#F97583"> def</span><span style="color:#B392F0"> bindsEnabled</span><span style="color:#F97583"> =</span></span>
<span class="line"><span style="color:#E1E4E8">  io.getquill.util.</span><span style="color:#B392F0">Messages</span><span style="color:#E1E4E8">.logBinds </span><span style="color:#F97583">||</span></span>
<span class="line"><span style="color:#E1E4E8">    underlying.underlying.isTraceEnabled</span></span></code></pre>
<p>It first checks Quill’s <code>logBinds</code> option, which is <code>false</code> by default but can be enabled by the user; otherwise, it checks if the current logger is currently logging traces.</p>
<p>However, a quick check of our code showed that:</p>
<ul>
<li>
<p>we didn’t modify <code>logBinds</code>, which should then be false</p>
</li>
<li>
<p>we were only logging logs for <code>Info</code> level and higher</p>
</li>
</ul>
<p>Since I couldn’t easily insert logs inside Quill’s code, I ran the project in debug mode on my machine and put a breakpoint on the call to <code>bindsEnabled</code> to find which of the two conditions was true: it turned out to be <code>isTraceEnabled</code>! The plot thickens…</p>
<p>Let’s take a look at where this <code>underlying</code> comes from:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="scala"><code><span class="line"><span style="color:#F97583">import</span><span style="color:#B392F0"> com</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">typesafe</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">scalalogging</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Logger</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#B392F0"> org</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">slf4j</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">LoggerFactory</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">val</span><span style="color:#FFAB70"> underlying</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Logger</span><span style="color:#F97583"> =</span><span style="color:#B392F0"> Logger</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">LoggerFactory</span><span style="color:#E1E4E8">.getLogger(name))</span></span></code></pre>
<p>It is good old slf4j, here wrapped by the <a href="https://github.com/lightbend-labs/scala-logging">scala-logging</a> library, something quite common in the Java/Scala ecosystem. I then had a look at the slf4j configuration but… didn’t find any.</p>
<p>It turns out we were using <a href="https://github.com/zio/zio-logging">ZIO Logging</a>, a library that offers compatibility between ZIO logging (you can simply write <code>ZIO.logDebug(...)</code> in ZIO applications and get a lot of contextual information in your logs) and various logging backends (including slf4j). When using that library, there are 2 options:</p>
<ul>
<li>
<p>the slf4j “backend” will forward all ZIO logs to slf4j: in that case, you configure your logs in the sl4j configuration file</p>
</li>
<li>
<p>the slf4j “bridge” will forward all slf4j logs to ZIO: in that case, you configure your logs using ZIO loggers</p>
</li>
</ul>
<p>As you may have guessed, since we didn’t have any slf4j configuration, we were using the bridge mode. But traces were disabled regardless.</p>
<p>I then took a look at the <a href="https://github.com/zio/zio-logging/blob/master/slf4j2-bridge/src/main/java/zio/logging/slf4j/bridge/Logger.java">implementation</a> of the sl4j <code>Logger</code> in the “bridge module” to find this:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="java"><code><span class="line"><span style="color:#E1E4E8">@</span><span style="color:#F97583">Override</span></span>
<span class="line"><span style="color:#F97583">public</span><span style="color:#F97583"> boolean</span><span style="color:#B392F0"> isTraceEnabled</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">  return</span><span style="color:#79B8FF"> true</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>Yes, <code>isTraceEnabled</code> is hardcoded to <code>true</code>! As are all the similar functions for the other log levels. Is that intentional? Couldn’t we simply get the log level from some kind of ZIO configuration?</p>
<p>It’s actually not that simple, because ZIO doesn’t really let you enable a particular log level; instead, you define a <code>ZLogger</code> that determines how to handle any log coming from <code>ZIO.log</code>. There’s an operator called <code>filterLogLevel</code> that can transform a <code>ZLogger</code> into a new one that ignores the given log levels, but it takes a function as a parameter, so there’s no way to get the “current log level”.</p>
<p>Note that the <code>ZIO.logLevel</code> operator in ZIO is slightly confusing: it doesn’t affect what will be logged or not; it only affects what the log level will be when you call <code>ZIO.log</code> without an explicit level.</p>
<p>Here’s how you define a logger that will print logs with level <code>Info</code> or higher:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="scala"><code><span class="line"><span style="color:#F97583">val</span><span style="color:#FFAB70"> logger</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> </span></span>
<span class="line"><span style="color:#B392F0">  ZLogger</span></span>
<span class="line"><span style="color:#E1E4E8">    .default</span></span>
<span class="line"><span style="color:#E1E4E8">    .map(println(_))</span></span>
<span class="line"><span style="color:#E1E4E8">    .filterLogLevel(_ </span><span style="color:#F97583">>=</span><span style="color:#B392F0"> LogLevel</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Info</span><span style="color:#E1E4E8">)</span></span></code></pre>
<p>Even trickier, it is possible to override the <code>ZLogger</code> in a particular scope or block using operators such as <code>ZIO.withLogger</code> and <code>ZIO.withLoggerScoped</code>. Indeed, the value of the current logger is stored in a <code>FiberRef</code> that can be overwritten locally. So not only is there no operator to get the current log level, but it is also contextual. A fiber might be writing everything above <code>Info</code>, while another fiber might be writing <code>Debug</code> logs too.</p>
<p>You might be wondering how the bridge performs when it needs to actually write a log. For the reasons I just mentioned, the bridge has to “inspect” the currently running fiber on the ZIO side in order to create a “runtime” with the proper context and call <code>ZIO.log</code> on it so that it runs the appropriate logger. This operation is not cheap, so it introduces an overhead every time you log something at any level, whether we are filtering them out in the logger or not.</p>
<p>This is quite visible when you use a very verbose Java library such as the official Kafka client. A closer inspection showed the following in our profiler:</p>
<figure class="rehype-figure-title"><img  loading="lazy" decoding="async" fetchpriority="auto" width="2224" height="880" src="/_astro/image-3.DlZXZrtD_15XxSH.webp" ></figure>
<p>As you can see, most of the CPU used inside the Kafka <code>poll</code> function is actually spent logging, particularly in <code>ZIOLoggerRuntime</code>, which is the code that tries to recover the current fiber context. Because Kafka is very verbose at trace and debug levels, and because the bridge forwards ALL logs to <code>ZIO.log</code> and lets the ZIO logger do the filtering, we end up with a situation like this.</p>
<h3 id="takeaways">Takeaways</h3>
<p>I did open <a href="https://github.com/zio/zio-logging/issues/809">an issue</a> on the zio-logging repo to raise the problem of enabling all log levels and the potential hidden cost it has with libraries like Quill that rely on these boolean functions to avoid expensive operations. However, for the reasons we just saw, it seems unlikely that a perfect solution will emerge that can both be consistent with the “current” ZIO logger and have minimal performance impact. At best, I think it is possible to define a fixed list of log levels we want to enable when we set up the bridge and disable the rest to short-circuit them.</p>
<p>In conclusion, I would recommend to anyone using zio-logging in <strong>performance-sensitive applications</strong> to prefer the simple slf4j module that redirects ZIO logs to slf4j rather than the slf4j-bridge. If you don’t care much about performance, using the bridge to have everything configured on the ZIO side is a completely reasonable option.</p>
<p>That’s it for today, I hope this was interesting. See you next time for another debugging session!</p>  </div> </div> </div> </article> </main>  <footer> <div class="app-container grid md:grid-cols-3 gap-12 py-16 border-t-2 border-foreground/50 dark:border-foreground-dark/50"> <div> <a href="/" class="block w-fit" aria-label="Home"> <svg width="36" height="36" viewBox="0 0 36 36" fill="none">
  <rect width="36" height="36" rx="8" fill="currentColor" opacity="0.1" />
  <text x="18" y="25" font-family="system-ui, -apple-system, sans-serif" font-size="18" font-weight="700" fill="currentColor" text-anchor="middle">PR</text>
</svg> </a> </div> <div> <h3 class="font-semibold text-2xl">Links</h3> <div class="flex flex-wrap gap-4 mt-4"> <a class="text-lg" href target="_blank" rel="noopener noreferrer"> Blog </a><a class="text-lg" href="https://github.com/sponsors/ghostdogpr" target="_blank" rel="noopener noreferrer"> Sponsor </a> <a href="/rss.xml" target="_blank" rel="noopener noreferrer" class="text-lg" aria-label="RSS Feed"> <svg width="1em" height="1em" class="w-6 h-6" data-icon="mdi:rss">   <symbol id="ai:mdi:rss" viewBox="0 0 24 24"><path fill="currentColor" d="M6.18 15.64a2.18 2.18 0 0 1 2.18 2.18C8.36 19 7.38 20 6.18 20C5 20 4 19 4 17.82a2.18 2.18 0 0 1 2.18-2.18M4 4.44A15.56 15.56 0 0 1 19.56 20h-2.83A12.73 12.73 0 0 0 4 7.27zm0 5.66a9.9 9.9 0 0 1 9.9 9.9h-2.83A7.07 7.07 0 0 0 4 12.93z"/></symbol><use href="#ai:mdi:rss"></use>  </svg> </a> </div> </div> <div> <h3 class="font-semibold text-2xl">Socials</h3> <div class="flex flex-wrap gap-4 mt-4"> <a class="text-lg" href="https://github.com/ghostdogpr" target="_blank" rel="noopener noreferrer"> GitHub </a><a class="text-lg" href="https://www.linkedin.com/in/pierrericadat/" target="_blank" rel="noopener noreferrer"> LinkedIn </a><a class="text-lg" href="https://twitter.com/ghostdogpr" target="_blank" rel="noopener noreferrer"> X / Twitter </a> </div> </div> </div> <div class="app-container flex justify-between items-center pb-6 text-center"> <p class="text-left md:text-center w-full">
Theme: <a class="underline" href="https://github.com/yashjawale/saral-theme-astro" target="_blank">Saral</a> </p> </div> </footer> </body></html>
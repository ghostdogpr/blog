<!DOCTYPE html><html lang="en"> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="generator" content="Astro v5.13.7"><!-- Favicons --><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="apple-mobile-web-app-title" content="Pierre Ricadat's Tech Blog"><!-- Canonical URL --><link rel="canonical" href="https://blog.pierre-ricadat.com/scala-3-migration-report-from-the-field/"><!-- Primary Meta Tags --><title>Scala 3 Migration: Report from the Field</title><meta name="title" content="Scala 3 Migration: Report from the Field"><meta name="description" content="April 30, 2024. I decided to dedicate a week to migrate our main project at work (a multiplayer mobile game server in production for over 4 years) from Scala...
"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://blog.pierre-ricadat.com/scala-3-migration-report-from-the-field/"><meta property="og:title" content="Scala 3 Migration: Report from the Field"><meta property="og:description" content="April 30, 2024. I decided to dedicate a week to migrate our main project at work (a multiplayer mobile game server in production for over 4 years) from Scala...
"><meta property="og:image" content="https://blog.pierre-ricadat.com/saral-og.jpg"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://blog.pierre-ricadat.com/scala-3-migration-report-from-the-field/"><meta property="twitter:title" content="Scala 3 Migration: Report from the Field"><meta property="twitter:description" content="April 30, 2024. I decided to dedicate a week to migrate our main project at work (a multiplayer mobile game server in production for over 4 years) from Scala...
"><meta property="twitter:image" content="https://blog.pierre-ricadat.com/saral-og.jpg"><!-- RSS Auto-discovery --><link rel="alternate" type="application/rss+xml" title="Pierre Ricadat's Tech Blog RSS Feed" href="https://blog.pierre-ricadat.com/rss.xml"><link rel="stylesheet" href="/_astro/_slug_.DSRIcTml.css"><script>!(function(w,p,f,c){if(!window.crossOriginIsolated && !navigator.serviceWorker) return;c=w[p]=Object.assign(w[p]||{},{"lib":"/~partytown/","debug":false});c[f]=(c[f]||[]).concat(["dataLayer.push"])})(window,'partytown','forward');/* Partytown 0.11.2 - MIT QwikDev */
const t={preserveBehavior:!1},e=e=>{if("string"==typeof e)return[e,t];const[n,r=t]=e;return[n,{...t,...r}]},n=Object.freeze((t=>{const e=new Set;let n=[];do{Object.getOwnPropertyNames(n).forEach((t=>{"function"==typeof n[t]&&e.add(t)}))}while((n=Object.getPrototypeOf(n))!==Object.prototype);return Array.from(e)})());!function(t,r,o,i,a,s,c,l,d,p,u=t,f){function h(){f||(f=1,"/"==(c=(s.lib||"/~partytown/")+(s.debug?"debug/":""))[0]&&(d=r.querySelectorAll('script[type="text/partytown"]'),i!=t?i.dispatchEvent(new CustomEvent("pt1",{detail:t})):(l=setTimeout(v,(null==s?void 0:s.fallbackTimeout)||1e4),r.addEventListener("pt0",w),a?y(1):o.serviceWorker?o.serviceWorker.register(c+(s.swPath||"partytown-sw.js"),{scope:c}).then((function(t){t.active?y():t.installing&&t.installing.addEventListener("statechange",(function(t){"activated"==t.target.state&&y()}))}),console.error):v())))}function y(e){p=r.createElement(e?"script":"iframe"),t._pttab=Date.now(),e||(p.style.display="block",p.style.width="0",p.style.height="0",p.style.border="0",p.style.visibility="hidden",p.setAttribute("aria-hidden",!0)),p.src=c+"partytown-"+(e?"atomics.js?v=0.11.2":"sandbox-sw.html?"+t._pttab),r.querySelector(s.sandboxParent||"body").appendChild(p)}function v(n,o){for(w(),i==t&&(s.forward||[]).map((function(n){const[r]=e(n);delete t[r.split(".")[0]]})),n=0;n<d.length;n++)(o=r.createElement("script")).innerHTML=d[n].innerHTML,o.nonce=s.nonce,r.head.appendChild(o);p&&p.parentNode.removeChild(p)}function w(){clearTimeout(l)}s=t.partytown||{},i==t&&(s.forward||[]).map((function(r){const[o,{preserveBehavior:i}]=e(r);u=t,o.split(".").map((function(e,r,o){var a;u=u[o[r]]=r+1<o.length?u[o[r]]||(a=o[r+1],n.includes(a)?[]:{}):(()=>{let e=null;if(i){const{methodOrProperty:n,thisObject:r}=((t,e)=>{let n=t;for(let t=0;t<e.length-1;t+=1)n=n[e[t]];return{thisObject:n,methodOrProperty:e.length>0?n[e[e.length-1]]:void 0}})(t,o);"function"==typeof n&&(e=(...t)=>n.apply(r,...t))}return function(){let n;return e&&(n=e(arguments)),(t._ptf=t._ptf||[]).push(o,arguments),n}})()}))})),"complete"==r.readyState?h():(t.addEventListener("DOMContentLoaded",h),t.addEventListener("load",h))}(window,document,navigator,top,window.crossOriginIsolated);;(e=>{e.addEventListener("astro:before-swap",e=>{let r=document.body.querySelector("iframe[src*='/~partytown/']");if(r)e.newDocument.body.append(r)})})(document);</script></head> <body class="text-foreground bg-background font-light dark:text-foreground-dark dark:bg-background-dark transition-colors"> <header class="fixed top-0 w-full z-40 bg-background dark:bg-background-dark"> <nav class=""> <div class="app-container flex justify-between items-center py-5"> <a href="/" aria-label="Home"> <svg width="36" height="36" viewBox="0 0 36 36" fill="none">
  <rect width="36" height="36" rx="8" fill="currentColor" opacity="0.1" />
  <text x="18" y="25" font-family="system-ui, -apple-system, sans-serif" font-size="18" font-weight="700" fill="currentColor" text-anchor="middle">PR</text>
</svg> </a> <div class="gap-8 hidden md:flex items-center"> <a href="/" class="text-lg" target="_self" data-astro-cid-rieiwi5x> Blog </a> <a href="https://github.com/sponsors/ghostdogpr" class="text-lg" target="_blank" data-astro-cid-rieiwi5x> Sponsor </a>  <div class="border-[1px] border-foreground dark:border-foreground-dark rounded-full flex justify-center items-center text-foreground dark:text-foreground-dark [&#38;>*:hover]:brightness-75 md:opacity-80 [&#38;>*]:cursor-pointer" data-astro-cid-lgn464si> <button data-theme="theme-auto" aria-label="Auto Theme" title="Set theme to follow system preference" class="theme-button theme-auto" data-astro-cid-lgn464si> <svg width="1em" height="1em" aria-hidden="true" data-astro-cid-lgn464si="true" class="duration-0 text-2xl md:text-xl" data-icon="mdi:brightness-auto">   <symbol id="ai:mdi:brightness-auto" viewBox="0 0 24 24"><path fill="currentColor" d="m14.3 16l-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69L8.69 4H4v4.69L.69 12L4 15.31V20h4.69L12 23.31L15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"/></symbol><use href="#ai:mdi:brightness-auto"></use>  </svg> </button> <button data-theme="theme-light" aria-label="Light Theme" title="Set theme to light" class="theme-button theme-light" data-astro-cid-lgn464si> <svg width="1em" height="1em" aria-hidden="true" data-astro-cid-lgn464si="true" class="duration-0 text-2xl md:text-xl" data-icon="mdi:white-balance-sunny">   <symbol id="ai:mdi:white-balance-sunny" viewBox="0 0 24 24"><path fill="currentColor" d="m3.55 19.09l1.41 1.41l1.8-1.79l-1.42-1.42M12 6c-3.31 0-6 2.69-6 6s2.69 6 6 6s6-2.69 6-6c0-3.32-2.69-6-6-6m8 7h3v-2h-3m-2.76 7.71l1.8 1.79l1.41-1.41l-1.79-1.8M20.45 5l-1.41-1.4l-1.8 1.79l1.42 1.42M13 1h-2v3h2M6.76 5.39L4.96 3.6L3.55 5l1.79 1.81zM1 13h3v-2H1m12 9h-2v3h2"/></symbol><use href="#ai:mdi:white-balance-sunny"></use>  </svg> </button> <button data-theme="theme-dark" aria-label="Dark Theme" title="Set theme to dark" class="theme-button theme-dark" data-astro-cid-lgn464si> <svg width="1em" height="1em" aria-hidden="true" data-astro-cid-lgn464si="true" class="duration-0 text-2xl md:text-xl" data-icon="mdi:moon-and-stars">   <symbol id="ai:mdi:moon-and-stars" viewBox="0 0 24 24"><path fill="currentColor" d="m17.75 4.09l-2.53 1.94l.91 3.06l-2.63-1.81l-2.63 1.81l.91-3.06l-2.53-1.94L12.44 4l1.06-3l1.06 3zm3.5 6.91l-1.64 1.25l.59 1.98l-1.7-1.17l-1.7 1.17l.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85c-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14c.4-.4.82-.76 1.27-1.08c.75-.53 1.93.36 1.85 1.19c-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82c-2.81 3.14-2.7 7.96.31 10.98c3.02 3.01 7.84 3.12 10.98.31"/></symbol><use href="#ai:mdi:moon-and-stars"></use>  </svg> </button> </div>  </div> <button class="md:hidden cursor-pointer" id="nav-open-btn" aria-label="Open navigation menu" title="Open navigation menu"> <svg width="32" height="32" aria-hidden="true" data-icon="mdi:menu">   <symbol id="ai:mdi:menu" viewBox="0 0 24 24"><path fill="currentColor" d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></symbol><use href="#ai:mdi:menu"></use>  </svg> </button> <!-- Mobile nav --> <div class="translate-x-full md:hidden fixed top-0 right-0 bg-background dark:bg-background-dark h-screen w-5/6 px-8 py-6 transition-transform z-40 border-l-[1px] border-background" id="mobile-menu"> <button id="nav-close-btn" class="ml-auto block cursor-pointer" aria-label="Close navigation menu" title="Close navigation menu"> <svg width="32" height="32" aria-hidden="true" data-icon="mdi:close">   <symbol id="ai:mdi:close" viewBox="0 0 24 24"><path fill="currentColor" d="M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12z"/></symbol><use href="#ai:mdi:close"></use>  </svg> </button> <div class="flex flex-col h-full items-start gap-8 pt-16"> <a href="/" class="text-4xl font-light" target="_self" data-astro-cid-rieiwi5x> Blog </a> <a href="https://github.com/sponsors/ghostdogpr" class="text-4xl font-light" target="_blank" data-astro-cid-rieiwi5x> Sponsor </a>  <div class="mt-4 border-[1px] border-foreground dark:border-foreground-dark rounded-full flex justify-center items-center text-foreground dark:text-foreground-dark [&#38;>*:hover]:brightness-75 md:opacity-80 [&#38;>*]:cursor-pointer" data-astro-cid-lgn464si> <button data-theme="theme-auto" aria-label="Auto Theme" title="Set theme to follow system preference" class="theme-button theme-auto" data-astro-cid-lgn464si> <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" data-astro-cid-lgn464si="true" class="duration-0 text-2xl md:text-xl" data-icon="mdi:brightness-auto">   <use href="#ai:mdi:brightness-auto"></use>  </svg> </button> <button data-theme="theme-light" aria-label="Light Theme" title="Set theme to light" class="theme-button theme-light" data-astro-cid-lgn464si> <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" data-astro-cid-lgn464si="true" class="duration-0 text-2xl md:text-xl" data-icon="mdi:white-balance-sunny">   <use href="#ai:mdi:white-balance-sunny"></use>  </svg> </button> <button data-theme="theme-dark" aria-label="Dark Theme" title="Set theme to dark" class="theme-button theme-dark" data-astro-cid-lgn464si> <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" data-astro-cid-lgn464si="true" class="duration-0 text-2xl md:text-xl" data-icon="mdi:moon-and-stars">   <use href="#ai:mdi:moon-and-stars"></use>  </svg> </button> </div>  </div> </div> </div> </nav> <script type="module">function e(){document.querySelector("#mobile-menu")?.classList.toggle("mobile-nav-open")}document.querySelector("#nav-open-btn")?.addEventListener("click",e);document.querySelector("#nav-close-btn")?.addEventListener("click",e);</script> </header> <script>
	function reComputeTheme() {
		if (
			localStorage.theme === 'dark' ||
			(!('theme' in localStorage) &&
				window.matchMedia('(prefers-color-scheme: dark)').matches)
		) {
			document.documentElement.classList.add('dark')
		} else {
			document.documentElement.classList.remove('dark')
		}

		const theme = localStorage.theme || 'auto'
		document
			.querySelectorAll(`[data-theme="theme-${theme}"]`)
			.forEach((el) => el.classList.add('active'))
	}

	function addThemeEventListeners() {
		themeButtons = document.querySelectorAll('.theme-button')
		themeButtons.forEach((button) => {
			button.addEventListener('click', () => {
				themeButtons.forEach((btn) => btn.classList.remove('active'))
				button.classList.add('active')
				if (button.dataset.theme === 'theme-auto') {
					localStorage.removeItem('theme')
					reComputeTheme()
				} else {
					localStorage.theme = button.dataset.theme.replace('theme-', '')
					document.documentElement.classList.toggle(
						'dark',
						button.dataset.theme === 'theme-dark'
					)
				}
			})
		})
	}

	// Set active class on OS theme change
	window
		.matchMedia('(prefers-color-scheme: dark)')
		.addEventListener('change', (_e) => {
			reComputeTheme()
		})

	// run recomputeTheme when screen crosses 768px
	window.matchMedia('(min-width: 768px)').addEventListener('change', (_e) => {
		addThemeEventListeners()
		reComputeTheme()
	})

	reComputeTheme()

	// Run on page load
	window.addEventListener('DOMContentLoaded', () => {
		addThemeEventListeners()
		reComputeTheme()
	})
</script>  <main> <article> <div class="app-container flex flex-col lg:flex-row-reverse justify-between gap-8 py-24 relative"> <div class="md:w-1/4 relative"> <div class="sticky top-0 md:top-28 hidden lg:block"> <nav class="py-12 rounded"><h2 class="text-2xl mr-2 pb-1 mb-3 font-bold">On This Page</h2><ul class="space-y-3"><li><a class="hover:underline underline-offset-4" href="#preamble">Preamble</a></li><li><a class="hover:underline underline-offset-4" href="#dropped-features">Dropped Features</a><ul class="ml-4 mt-2 space-y-2 border-l border-gray-300 dark:border-gray-700 pl-4"><li><a class="hover:underline underline-offset-4 text-sm opacity-80" href="#macro-annotations">Macro annotations</a></li><li><a class="hover:underline underline-offset-4 text-sm opacity-80" href="#type-projections">Type projections</a></li></ul></li><li><a class="hover:underline underline-offset-4" href="#unsupportedbroken-libraries">Unsupported/broken libraries</a><ul class="ml-4 mt-2 space-y-2 border-l border-gray-300 dark:border-gray-700 pl-4"><li><a class="hover:underline underline-offset-4 text-sm opacity-80" href="#newtypes-and-refined-types">Newtypes and refined types</a></li><li><a class="hover:underline underline-offset-4 text-sm opacity-80" href="#magnolia-typeclass-derivation">Magnolia typeclass derivation</a></li></ul></li><li><a class="hover:underline underline-offset-4" href="#macros">Macros</a></li><li><a class="hover:underline underline-offset-4" href="#dependency-issues">Dependency issues</a></li><li><a class="hover:underline underline-offset-4" href="#slow-compile-time">Slow compile time</a></li><li><a class="hover:underline underline-offset-4" href="#intellij-support">IntelliJ support</a></li><li><a class="hover:underline underline-offset-4" href="#compiler-flags">Compiler flags</a></li><li><a class="hover:underline underline-offset-4" href="#conclusion">Conclusion</a></li></ul></nav> </div> </div> <div class="grow w-full md:max-w-[75ch]"> <div> <h1 class="text-4xl sm:text-5xl leading-snug pt-12 font-bold"> Scala 3 Migration: Report from the Field </h1> <div class="text-lg flex items-center gap-4 flex-wrap py-8"> <!-- Publish date --> <span> <svg width="1em" height="1em" class="inline-block text-primary dark:text-primary-dark" data-icon="mdi:calendar-month-outline">   <symbol id="ai:mdi:calendar-month-outline" viewBox="0 0 24 24"><path fill="currentColor" d="M7 11h2v2H7zm14-6v14c0 1.11-.89 2-2 2H5a2 2 0 0 1-2-2V5c0-1.1.9-2 2-2h1V1h2v2h8V1h2v2h1a2 2 0 0 1 2 2M5 7h14V5H5zm14 12V9H5v10zm-4-6v-2h2v2zm-4 0v-2h2v2zm-4 2h2v2H7zm8 2v-2h2v2zm-4 0v-2h2v2z"/></symbol><use href="#ai:mdi:calendar-month-outline"></use>  </svg> <time datetime="2025-02-04T00:00:00.000Z"> 4 Feb 2025 </time> </span> <!-- Updated date -->  <!-- Read time --> <span> <svg width="1em" height="1em" class="inline-block text-primary dark:text-primary-dark" data-icon="mdi:clock-time-four-outline">   <symbol id="ai:mdi:clock-time-four-outline" viewBox="0 0 24 24"><path fill="currentColor" d="M12 20c4.4 0 8-3.6 8-8s-3.6-8-8-8s-8 3.6-8 8s3.6 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10S2 17.5 2 12S6.5 2 12 2m5 11.9l-.7 1.3l-5.3-2.9V7h1.5v4.4z"/></symbol><use href="#ai:mdi:clock-time-four-outline"></use>  </svg> 17 min read </span> </div>  </div> <div class="prose prose-neutral prose-lg md:prose-xl dark:prose-invert prose-img:rounded-xl prose-figure:text-center prose-img:mx-auto">  <p>April 30, 2024. I decided to dedicate a week to migrate our main project at work (a multiplayer mobile game server in production for over 4 years) from Scala 2.13 to Scala 3.</p>
<p>May 7, 2024. I gave up. The removal of several features from Scala 3 (macro annotations, type projections, etc.), combined with the large number of changes necessary for the migration, was overwhelming. I was barely able to migrate a single module, had to modify thousands of lines of code (while my colleagues were adding new features to the main branch, a large number of merge conflicts were already appearing), and the IDE was completely unresponsive due to hundreds of compile errors. At that point, I thought the project might be stuck on Scala 2 forever.</p>
<p>Flash forward to January 2025. I had a little free time, so I decided to give it another try. And (spoiler!) this time I made it to the end. Let’s see what the various problems I encountered were, the changes I had to make, and the workarounds I implemented.</p>
<h2 id="preamble">Preamble</h2>
<p>The main place to look when starting a migration is the official <a href="https://docs.scala-lang.org/scala3/guides/migration/compatibility-intro.html">Scala 3 Migration Guide</a>. It contains a lot of information about the changes in the language and details on how to proceed.</p>
<p>As I mentioned, the large number of changes required was an issue because it caused a lot of merge conflicts with the main branch. It was not possible to stop all other developments during the migration, so I decided to apply as many changes as possible in the Scala 2 main branch to avoid these conflicts.</p>
<p>The main thing you can do while still on Scala 2.13 is to compile with the <code>-Xsource:3</code> compiler flag, which enables the Scala 3 syntax for imports (<code>*</code> instead of <code>_</code>, <code>as</code> instead of <code>=></code>), intersection types (<code>&#x26;</code> instead of <code>with</code>), and more, and also turns on a number of warnings for things no longer supported in Scala 3 (e.g., <code>.map(CaseClass)</code> should become <code>.map(CaseClass.apply)</code>).</p>
<p>Most of those changes were easy to apply, but there were a lot of them, which was challenging. Scala 3 offers a “migration mode” and is able to rewrite the code with the new syntax, but this is not applicable if you want to apply these changes in a Scala 2 codebase. My salvation actually came from IntelliJ, which has an inspection for code compiled with <code>-Xsource:3</code> and a quick fix action to replace all the code at once. Incredibly useful!</p>
<figure class="rehype-figure-title"><img alt="IntelliJ inspection for -Xsource:3" loading="lazy" decoding="async" fetchpriority="auto" width="1636" height="618" src="/_astro/image-1.CKrgBqyb_1lYybF.webp" ></figure>
<p>IntelliJ even lets you select which of these changes you want to apply, so I excluded the “<code>case</code> in pattern bindings of for-comprehensions” because it transformed the code in a weird, unnecessary way.</p>
<p>After this was done, I was able to apply a large number of changes directly to our main branch, avoiding many more conflicts!</p>
<figure class="rehype-figure-title"><img  loading="lazy" decoding="async" fetchpriority="auto" width="320" height="66" src="/_astro/image-2.vQxrvmh9_KKNwy.webp" ></figure>
<h2 id="dropped-features">Dropped Features</h2>
<p>While it brought a number of new and interesting features such as enums or opaque types, Scala 3 dropped a few features altogether, and this proved to be particularly challenging for us. The dropped features are listed <a href="https://docs.scala-lang.org/scala3/reference/dropped-features/">on this page</a>, and there were two of them that we relied on heavily: macro annotations and type projections.</p>
<h3 id="macro-annotations">Macro annotations</h3>
<p>Macro annotations let you annotate Scala 2 types to generate code at compile-time, most typically by adding code to the companion object of annotated classes.</p>
<p>For example, using the <a href="https://github.com/circe/circe">Circe JSON library</a>, you could write this:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="scala"><code><span class="line"><span style="color:#F97583">@</span><span style="color:#B392F0">JsonCodec</span></span>
<span class="line"><span style="color:#F97583">case</span><span style="color:#F97583"> class</span><span style="color:#B392F0"> Bar</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">i</span><span style="color:#E1E4E8">: </span><span style="color:#B392F0">Int</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">s</span><span style="color:#E1E4E8">: </span><span style="color:#B392F0">String</span><span style="color:#E1E4E8">)</span></span></code></pre>
<p>This will automatically generate an implicit <code>Codec[Bar]</code> in the companion object of <code>Bar</code>. Very concise, very convenient. In the case of Circe, there was an “easy” workaround, which is to use the <code>derives</code> keyword available in Scala 3. I put quotes around “easy” because, for some reason, it is not mentioned at all in the <a href="https://circe.github.io/circe/codecs/semiauto-derivation.html#jsoncodec">Circe documentation</a>.</p>
<p>The code above can be changed to the following for the same result:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="scala"><code><span class="line"><span style="color:#F97583">case</span><span style="color:#F97583"> class</span><span style="color:#B392F0"> Bar</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">i</span><span style="color:#E1E4E8">: </span><span style="color:#B392F0">Int</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">s</span><span style="color:#E1E4E8">: </span><span style="color:#B392F0">String</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">derives</span><span style="color:#B392F0"> Codec</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">AsObject</span></span></code></pre>
<p>Case closed? Not exactly, because our main use of macro annotations was not with Circe, but with <a href="https://github.com/optics-dev/Monocle">Monocle</a> and its <code>@Lenses</code> annotation.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="scala"><code><span class="line"><span style="color:#F97583">@</span><span style="color:#B392F0">Lenses</span></span>
<span class="line"><span style="color:#F97583">case</span><span style="color:#F97583"> class</span><span style="color:#B392F0"> Bar</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">i</span><span style="color:#E1E4E8">: </span><span style="color:#B392F0">Int</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">s</span><span style="color:#E1E4E8">: </span><span style="color:#B392F0">String</span><span style="color:#E1E4E8">)</span></span></code></pre>
<p>This will generate the following in the companion object of <code>Bar</code>:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="scala"><code><span class="line"><span style="color:#F97583">object</span><span style="color:#B392F0"> Bar</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">  val</span><span style="color:#FFAB70"> i</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Lens</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">Bar</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">Int</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">=</span><span style="color:#F97583"> ???</span><span style="color:#6A737D"> // implementation omitted for clarity</span></span>
<span class="line"><span style="color:#F97583">  val</span><span style="color:#FFAB70"> s</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Lens</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">Bar</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">String</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">=</span><span style="color:#F97583"> ???</span><span style="color:#E1E4E8"> </span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>Our project, being a complex game, has a huge user state object, lots of business logic, and domain entities. Lenses allow us to modify parts of the user state in a concise and elegant manner without having to use a chain of nested <code>copy</code>.</p>
<p>The removal of that macro annotation left us with no clear path or alternative for the migration. Unlike the Circe case, this is not a typeclass instance, so we can’t use the <code>derives</code> keyword: we need a <code>val</code> generated for each field of the case class. There is an <a href="https://github.com/optics-dev/Monocle/issues/1337">open issue</a> in the Monocle repository that discusses various options, but nothing tangible (Kit Langton has an <a href="https://contributors.scala-lang.org/t/scala-3-macro-annotations-and-code-generation/6035/69">interesting approach</a> using <code>Selectable</code>, but this is not supported by IntelliJ).</p>
<p>One obvious alternative was to write those lenses ourselves. That was definitely doable; however, it would have required considerable effort to write thousands of these, and it would have added an enormous amount of boilerplate to the project, making Scala 3 quite unpopular within our team. This alone stopped the migration effort I started in 2024.</p>
<p>We are always trying to reduce boilerplate in our project, so we’ve used a few techniques over the years to address it. Sometimes it’s doable with macros or mirrors, but one way is to use sbt’s source generators, which allow you to run some custom code before compilation to generate additional source code files. Combined with <a href="https://scalameta.org/">Scalameta</a>, you can parse and analyze your own code to generate more code. It is ultimately this technique that we used to generate the lenses.</p>
<p>The code generation works like this:</p>
<ul>
<li>
<p>Look for all case classes in a specific module that contain the <code>@lenses</code> annotation</p>
</li>
<li>
<p>For each of those case classes, create an object</p>
<ul>
<li>For each field of the case class, create a lens with the appropriate types</li>
</ul>
</li>
</ul>
<p>Using Scalameta is a little bit involved, so I’ve shared a snippet of our code <a href="https://gist.github.com/ghostdogpr/3b5bd33dd3356e16434db42595924bf4">in this gist</a> so that it may be used by others. One downside of this approach is that the generated lenses are no longer in the companion objects of the case classes (we can generate new source files but not modify the existing ones), which required us to change all the lenses usage to use different object names. But it was worth it since it unlocked the migration path.</p>
<p>Note that a “macro annotation” feature was added to Scala 3, but it is much more limited than what was possible in Scala 2 and does not allow implementing the Monocle <code>@Lenses</code> annotation (the generated code is not visible to the user).</p>
<h3 id="type-projections">Type projections</h3>
<p>Imagine you have a type <code>Request</code> that has an abstract <code>type Result</code> defined inside it.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="scala"><code><span class="line"><span style="color:#F97583">trait</span><span style="color:#B392F0"> Request</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">  type</span><span style="color:#B392F0"> Result</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">case</span><span style="color:#F97583"> class</span><span style="color:#B392F0"> IntRequest</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">extends</span><span style="color:#B392F0"> Request</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">  type</span><span style="color:#B392F0"> Result</span><span style="color:#F97583"> =</span><span style="color:#B392F0"> Int</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>In Scala 2, you can write a function that, for a given <code>Request</code>, returns <code>Request#Result</code>, meaning it returns the <code>Result</code> that matches the subtype of <code>Request</code> that was used. So if <code>Request</code> is <code>IntRequest</code>, we will get an <code>Int</code> back.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="scala"><code><span class="line"><span style="color:#F97583">def</span><span style="color:#B392F0"> foo</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">R</span><span style="color:#F97583"> &#x3C;:</span><span style="color:#B392F0"> Request</span><span style="color:#E1E4E8">](</span><span style="color:#FFAB70">req</span><span style="color:#E1E4E8">: </span><span style="color:#B392F0">Request</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> R</span><span style="color:#F97583">#</span><span style="color:#B392F0">Result</span><span style="color:#F97583"> =</span><span style="color:#F97583"> ???</span></span></code></pre>
<p>This is no longer possible in Scala 3 if <code>R</code> is abstract! You get a compile error saying <code>R is not a legal path since it is not a concrete type</code>. There is an easy workaround if you have a value of type <code>Request</code>, which is to use a function dependent type and return <code>req.Result</code>.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="scala"><code><span class="line"><span style="color:#F97583">def</span><span style="color:#B392F0"> foo</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">R</span><span style="color:#F97583"> &#x3C;:</span><span style="color:#B392F0"> Request</span><span style="color:#E1E4E8">](</span><span style="color:#FFAB70">req</span><span style="color:#E1E4E8">: </span><span style="color:#B392F0">Request</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> req.</span><span style="color:#B392F0">Result</span><span style="color:#F97583"> =</span><span style="color:#F97583"> ???</span></span></code></pre>
<p>However, our code had various uses of this pattern, and not all of them could be changed to a function dependent type. We ended up using a combination of different techniques depending on each case: function dependent types in some places, typeclasses in others, and we had to give up on making the code generic in a few places. Overall, this felt like a regression from the old code, but at least we were able to make it compile without changing too much code.</p>
<p>EDIT: After publishing this article, Voytek Pituła <a href="https://www.reddit.com/r/scala/comments/1ihf75z/comment/mawmkn0/">suggested a different workaround on Reddit</a> using match types, and I was able to apply it successfully in the places where I had no alternatives. It made the code much nicer! I had heard of match types as an alternative before, but I thought I would have to construct a giant pattern matching with the list of all requests and their matching results. I had no idea it could be used in a generic way. Here’s his approach applied to our example:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="scala"><code><span class="line"><span style="color:#F97583">trait</span><span style="color:#B392F0"> Request</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">  type</span><span style="color:#B392F0"> Result</span><span style="color:#E1E4E8"> </span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">object</span><span style="color:#B392F0"> Request</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">  type</span><span style="color:#B392F0"> Aux</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">T</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">=</span><span style="color:#B392F0"> Request</span><span style="color:#E1E4E8"> { </span><span style="color:#F97583">type</span><span style="color:#B392F0"> Result</span><span style="color:#F97583"> =</span><span style="color:#B392F0"> T</span><span style="color:#E1E4E8"> }</span></span>
<span class="line"><span style="color:#F97583">  type</span><span style="color:#B392F0"> Result</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">T</span><span style="color:#F97583"> &#x3C;:</span><span style="color:#B392F0"> Request</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">=</span><span style="color:#B392F0"> T</span><span style="color:#F97583"> match</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    case</span><span style="color:#B392F0"> Aux</span><span style="color:#E1E4E8">[s] </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> s</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">def</span><span style="color:#B392F0"> foo</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">T</span><span style="color:#F97583"> &#x3C;:</span><span style="color:#B392F0"> Request</span><span style="color:#E1E4E8">]</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Request</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Result</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">T</span><span style="color:#E1E4E8">]</span></span></code></pre>
<h2 id="unsupportedbroken-libraries">Unsupported/broken libraries</h2>
<p>Most libraries we were using were available on Scala 3, and for a few missing ones (mostly related to Spark or Kryo), we used <code>cross(CrossVersion.for3Use2_13)</code>, which allows depending on a library built for Scala 2.13.</p>
<p>However, a few of them were not available or didn’t work as expected, so they required a complete change.</p>
<h3 id="newtypes-and-refined-types">Newtypes and refined types</h3>
<p>In Scala 2, we were using a combination of <a href="https://github.com/estatico/scala-newtype">scala-newtype</a> and <a href="https://github.com/fthomas/refined">refined</a> to define custom types used all over our business logic (IDs, bounded values, etc.). There is no Scala 3 version of scala-newtype, which makes sense because it can be entirely replaced by opaque types. Refined is sneakier: it has a Scala 3 version, but if you try to use it, you will notice that it is only partially implemented; the macros are missing, so the library is not usable (the first example in their README doesn’t compile).</p>
<p>In another project using Scala 3, we were already using the <a href="https://github.com/kitlangton/neotype">neotype</a> library, which lets you define both newtypes and refined types and is built on top of opaque types, therefore having no runtime cost. We switched to using this library instead. It might sound simple on paper, but we rely on these types so much that it was quite an invasive change impacting a lot of files. At least the migrated code felt better than the old one since writing refined type validation is nicer and slightly less boilerplate-y, and the runtime impact was reduced.</p>
<h3 id="magnolia-typeclass-derivation">Magnolia typeclass derivation</h3>
<p>Another issue we had was with typeclass derivation using <a href="https://github.com/softwaremill/magnolia">Magnolia</a>. While the library supports Scala 3, our existing derivation code caused a compile error for reaching <code>-Xmax-inlines</code> (too much inlined code). I tried to increase it up to 10,000 (!) and it finally failed with a stack overflow in the compiler.</p>
<p>The failing derivation occurred while deriving a sealed trait with a LOT of subtypes (~1,000), but there was already a typeclass instance for each of the subtypes. After looking at the internals of Magnolia, I noticed that a recursive method was used to fold over the list of subtypes, and that method was not tail-recursive, explaining why the number of inlines (and the stack depth) was increasing proportionally to the number of subtypes. To make matters worse, that recursive method also called <code>distinctBy</code> and <code>sortBy</code> on the list of subtypes at <em>every</em> iteration, which is pretty bad when you have lots of them. I opened <a href="https://github.com/softwaremill/magnolia/issues/565">an issue</a> to report this behavior and changed the code locally, but then I ran into a <code>Method too large</code> error because the generated code was longer than what the JVM allows.</p>
<p>After doing a little research, I came across a great feature of Scala 3 that is poorly documented: <code>Tuple.Map</code>. Mirrors give you access to two tuples: for a sum type, <code>MirroredElemLabels</code> is a tuple with the names of the subtypes, while <code>MirroredElemTypes</code> is a tuple with the actual subtypes. You can use <code>summonAll</code> and <code>Tuple.Map</code> to materialize the list of names of those types or even to summon a typeclass instance for each of them.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="scala"><code><span class="line"><span style="color:#F97583">trait</span><span style="color:#B392F0"> TC</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">A</span><span style="color:#E1E4E8">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">inline</span><span style="color:#F97583"> def</span><span style="color:#B392F0"> gen</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">A</span><span style="color:#E1E4E8">](</span><span style="color:#F97583">using</span><span style="color:#FFAB70"> m</span><span style="color:#E1E4E8">: </span><span style="color:#B392F0">Mirror</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">SumOf</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">A</span><span style="color:#E1E4E8">])</span><span style="color:#F97583">:</span><span style="color:#B392F0"> TC</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">A</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">  // get TC instances of all subtypes</span></span>
<span class="line"><span style="color:#F97583">  val</span><span style="color:#FFAB70"> subTypes</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> compiletime.summonAll[</span><span style="color:#B392F0">Tuple</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Map</span><span style="color:#E1E4E8">[m.</span><span style="color:#B392F0">MirroredElemTypes</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">TC</span><span style="color:#E1E4E8">]]</span></span>
<span class="line"><span style="color:#F97583">  new</span><span style="color:#B392F0"> TC</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">A</span><span style="color:#E1E4E8">] {</span></span>
<span class="line"><span style="color:#F97583">    ???</span><span style="color:#6A737D"> // given (a: A), we can then use subTypes(m.ordinal(a)).asInstanceOf[TC[A]]</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>I posted a <a href="https://gist.github.com/ghostdogpr/6f2ca0939c67765a0657a255ed653765">full example on Gist</a> that shows how to derive a typeclass for a sealed trait without even needing Magnolia. This solution is very concise and does not run into inline or <code>Method too large</code> issues. I just wish there were more learning materials about these <code>Tuple</code> utilities because I think they are very powerful.</p>
<h2 id="macros">Macros</h2>
<p>We had a few macros developed in-house, mostly to reduce boilerplate code. They proved relatively easy to port, except for one of them. The reason it was difficult is that Scala 3 macros are much more strict than Scala 2 macros, which let you generate any kind of code. On the other hand, Scala 3 macros require that the code you generate is valid in the context where the macro is defined (which might be different from where the macro is used, making things trickier). I am not a macro expert, so apologies if this is a little imprecise; my colleague <a href="https://x.com/nox737">@nox737</a> is the one who made the magic happen.</p>
<p>It took us quite a long time to make the macro compile with these restrictions (note: AI agents were not helpful at all for this kind of task!), and in the end, the code still failed to compile because of a <code>Method too large</code> error. Compile time felt a bit slower too. We ended up removing the macro entirely and replacing it with another source generator written with Scalameta. It made the code easier to inspect and to split into smaller chunks.</p>
<h2 id="dependency-issues">Dependency issues</h2>
<p>As mentioned earlier, we used <code>CrossVersion.for3Use2_13</code> for a few libraries not available in Scala 3, but one tough problem arose. One of those libraries was <a href="https://github.com/scalapb/sparksql-scalapb">sparksql-scalapb</a>, which lets us use protobuf with Spark. This library depends on Spark, so it is only available for 2.13. It also depends on <code>scalapb-runtime</code>, so depending on it brings <code>scalapb_runtime_2.13</code> into dependencies. The problem is that the rest of our code already depended on <code>scalapb_runtime_3</code>. In that case, sbt failed to resolve the build with this error:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>Modules were resolved with conflicting cross-version suffixes in ProjectRef(uri("..."), "spark"):</span></span>
<span class="line"><span>org.scala-lang.modules:scala-collection-compat _3, _2.13</span></span>
<span class="line"><span>com.thesamet.scalapb:lenses _3, _2.13</span></span>
<span class="line"><span>com.thesamet.scalapb:scalapb-runtime _3, _2.13</span></span></code></pre>
<p>In other words, you can’t depend on the same library in both 2.13 and 3 versions.</p>
<p>I initially tried to solve that issue by shading dependencies, but it didn’t work because one function we use from <code>sparksql-scalapb</code> expects a specific input extending a type from ScalaPB, which means the rest of our code needs to extend that type. If that type is shaded only in the spark module, it doesn’t match the type from our other modules.</p>
<p>The solution was actually relatively simple: I forked <code>sparksql-scalapb</code> and made it compile with Scala 3, depending on <code>scalapb_runtime_3</code> and using <code>CrossVersion.for3Use2_13</code> for its other dependencies. The code was very straightforward to port, with just some minor things to fix. Then I embedded the produced JAR in our project instead of depending on the 2.13 library. I had to add the transitive dependencies of that library explicitly in our project, and that was it.</p>
<h2 id="slow-compile-time">Slow compile time</h2>
<p>Once all the code was migrated and I was able to compile successfully for the first time, I noticed that it was taking longer than usual. I also noticed that IntelliJ was constantly compiling to show syntax highlighting. There was definitely something wrong. I had already debugged slow compile times with Scala 2 and was accustomed to using the <code>-Vstatistics</code> compiler flag to see which phases were taking time, and even using <a href="https://github.com/scalacenter/scalac-profiling">scalac-profiling</a> to profile the compilation. Unfortunately, a little research made me realize that such tools did not exist for Scala 3. After asking around on <a href="https://x.com/ghostdogpr/status/1881657774817591559">Twitter</a>, I heard that the new version of Scala (3.6.3) released a day earlier was <a href="https://www.scala-lang.org/news/3.6.3/">bringing a compiler flag to generate compiler traces</a>. What a nice timing, I really got lucky with this one.</p>
<p>I immediately upgraded from 3.6.2 to 3.6.3 and enabled the traces. Within minutes, I was able to generate the following flamegraph:</p>
<figure class="rehype-figure-title"><img  loading="lazy" decoding="async" fetchpriority="auto" width="4096" height="631" src="/_astro/image-3.BNvaN-UE_ZYgl5m.webp" ></figure>
<p>This was extremely useful: as you can see, it breaks down the compilation time by phases, but also by files and even methods! This helped me pinpoint which code was slow to compile. Even though I did not really understand why it was slow (I tried to reproduce it in an isolated example but failed), I was able to refactor the code in a way that made it fast. The issue was about using an extremely large intersection type (with over 100+ types) as a ZIO environment. Reorganizing the environment into fewer types completely solved this issue, made the compile time on par with 2.13, and made IntelliJ very reactive.</p>
<p>This tool is so useful that I plan to spend more time on it in the future because I am pretty sure that it will allow me to find other slow points, considering how detailed the output is. But my goal for the migration was only to be as fast as with 2.13.</p>
<h2 id="intellij-support">IntelliJ support</h2>
<p>Speaking of IntelliJ, I did run into a couple of issues, which I reported to JetBrains:</p>
<ul>
<li>
<p><a href="https://youtrack.jetbrains.com/issue/SCL-23387/Monocles-focus-macro-is-not-supported-in-Scala-3-works-with-Scala-2-scala-3-context-functions">Context functions are not well supported when combined with an actual function</a> (e.g., <code>Context ?=> From => To</code>), which comes up when using the Monocle <code>focus</code> macro.</p>
</li>
<li>
<p><a href="https://youtrack.jetbrains.com/issue/SCL-21142/scala3-cant-resolve-definitions-from-intersection-types-from-self-type">Using a self type in combination with intersection types is broken</a> (e.g., <code>trait A { self: B &#x26; C =></code>), fortunately, it works when using <code>with</code> instead of <code>&#x26;</code>, so the workaround was easy.</p>
</li>
</ul>
<p>I hope these bugs get fixed in the near future since they have very simple and easy reproducers (the first one was fixed as I was writing this post, though not released yet). I briefly looked into it, but the Scala plugin for IntelliJ is not really approachable, and I didn’t even know where to start looking.</p>
<p>Other than that, IntelliJ support was pretty good. One thing I recommend is to select <code>Use separate compiler output paths</code> in the sbt configuration menu because the sbt shell and IntelliJ’s own compiler tend to conflict with each other otherwise.</p>
<h2 id="compiler-flags">Compiler flags</h2>
<p>Here are a few notable compiler flags I ended up using:</p>
<ul>
<li>
<p><code>-language:experimental.betterFors</code> (available under <code>-experimental</code>): this allows using <code>=</code> on the first line of for-comprehensions, and it also optimizes the generated bytecode by avoiding the extra <code>map</code> call at the end of the <code>flatMap</code> calls.</p>
</li>
<li>
<p><code>-no-indent</code>: I am strongly against significant indentation in Scala, wish it never happened, but at least I am glad it is easy to disable. This is coupled with <code>runner.dialectOverride.allowSignificantIndentation = false</code> in Scalafmt.</p>
</li>
<li>
<p><code>-Wunused:all</code>: I had a bunch of <code>@nowarn</code> I had to add with Scala 2 because of false positives, and I was able to remove them. It also found some extra unused code that Scala 2 didn’t detect, so it seemed to work better.</p>
</li>
</ul>
<h2 id="conclusion">Conclusion</h2>
<figure class="rehype-figure-title"><img  loading="lazy" decoding="async" fetchpriority="auto" width="1544" height="112" src="/_astro/image-4.BBNMuMaH_3qbrx.webp" ></figure>
<p>Finally, on February 4, the CI turned green on this PR. It has been a long journey with a lot of hurdles, but the situation felt much better in 2025 than a year before. Overall, our code did not change heavily, and most of the changes are for the best. The two things that I really regret are the lack of macro annotations (fortunately, sbt source generators and Scalameta are powerful enough to emulate it) and the removal of general type projections that made our code uglier in some places.</p>
<p>To wrap things up, I am glad our main project did not become a painful legacy stuck in the past, and I am now excited to be able to play with some of the powerful tools that Scala 3 has to offer, particularly around metaprogramming. I hope this read will be helpful to others, whether you have a similar migration to perform or are involved directly with the development of the language and its tooling.</p>  </div> </div> </div> </article> </main>  <footer> <div class="app-container grid md:grid-cols-3 gap-12 py-16 border-t-2 border-foreground/50 dark:border-foreground-dark/50"> <div> <a href="/" class="block w-fit" aria-label="Home"> <svg width="36" height="36" viewBox="0 0 36 36" fill="none">
  <rect width="36" height="36" rx="8" fill="currentColor" opacity="0.1" />
  <text x="18" y="25" font-family="system-ui, -apple-system, sans-serif" font-size="18" font-weight="700" fill="currentColor" text-anchor="middle">PR</text>
</svg> </a> </div> <div> <h3 class="font-semibold text-2xl">Links</h3> <div class="flex flex-wrap gap-4 mt-4"> <a class="text-lg" href target="_blank" rel="noopener noreferrer"> Blog </a><a class="text-lg" href="https://github.com/sponsors/ghostdogpr" target="_blank" rel="noopener noreferrer"> Sponsor </a> <a href="rss.xml" target="_blank" rel="noopener noreferrer" class="text-lg" aria-label="RSS Feed"> <svg width="1em" height="1em" class="w-6 h-6" data-icon="mdi:rss">   <symbol id="ai:mdi:rss" viewBox="0 0 24 24"><path fill="currentColor" d="M6.18 15.64a2.18 2.18 0 0 1 2.18 2.18C8.36 19 7.38 20 6.18 20C5 20 4 19 4 17.82a2.18 2.18 0 0 1 2.18-2.18M4 4.44A15.56 15.56 0 0 1 19.56 20h-2.83A12.73 12.73 0 0 0 4 7.27zm0 5.66a9.9 9.9 0 0 1 9.9 9.9h-2.83A7.07 7.07 0 0 0 4 12.93z"/></symbol><use href="#ai:mdi:rss"></use>  </svg> </a> </div> </div> <div> <h3 class="font-semibold text-2xl">Socials</h3> <div class="flex flex-wrap gap-4 mt-4"> <a class="text-lg" href="https://github.com/ghostdogpr" target="_blank" rel="noopener noreferrer"> GitHub </a><a class="text-lg" href="https://www.linkedin.com/in/pierrericadat/" target="_blank" rel="noopener noreferrer"> LinkedIn </a><a class="text-lg" href="https://twitter.com/ghostdogpr" target="_blank" rel="noopener noreferrer"> X / Twitter </a> </div> </div> </div> <div class="app-container flex justify-between items-center pb-6 text-center"> <p class="text-left md:text-center w-full">
Theme: <a class="underline" href="https://github.com/yashjawale/saral-theme-astro" target="_blank">Saral</a> </p> </div> </footer> </body></html>
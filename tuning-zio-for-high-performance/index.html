<!DOCTYPE html><html lang="en"> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="generator" content="Astro v5.13.7"><!-- Favicons --><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="apple-mobile-web-app-title" content="Pierre Ricadat's Tech Blog"><!-- Canonical URL --><link rel="canonical" href="https://blog.pierre-ricadat.com/tuning-zio-for-high-performance/"><!-- Primary Meta Tags --><title>Tuning ZIO for high performance</title><meta name="title" content="Tuning ZIO for high performance"><meta name="description" content="Let's start with a disclaimer. What is discussed in this article is not the ultimate truth: how to make your application faster highly depends on what your a...
"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://blog.pierre-ricadat.com/tuning-zio-for-high-performance/"><meta property="og:title" content="Tuning ZIO for high performance"><meta property="og:description" content="Let's start with a disclaimer. What is discussed in this article is not the ultimate truth: how to make your application faster highly depends on what your a...
"><meta property="og:image" content="https://blog.pierre-ricadat.com/saral-og.jpg"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://blog.pierre-ricadat.com/tuning-zio-for-high-performance/"><meta property="twitter:title" content="Tuning ZIO for high performance"><meta property="twitter:description" content="Let's start with a disclaimer. What is discussed in this article is not the ultimate truth: how to make your application faster highly depends on what your a...
"><meta property="twitter:image" content="https://blog.pierre-ricadat.com/saral-og.jpg"><!-- RSS Auto-discovery --><link rel="alternate" type="application/rss+xml" title="Pierre Ricadat's Tech Blog RSS Feed" href="https://blog.pierre-ricadat.com/rss.xml"><link rel="stylesheet" href="/_astro/_slug_.DSRIcTml.css"><script>!(function(w,p,f,c){if(!window.crossOriginIsolated && !navigator.serviceWorker) return;c=w[p]=Object.assign(w[p]||{},{"lib":"/~partytown/","debug":false});c[f]=(c[f]||[]).concat(["dataLayer.push"])})(window,'partytown','forward');/* Partytown 0.11.2 - MIT QwikDev */
const t={preserveBehavior:!1},e=e=>{if("string"==typeof e)return[e,t];const[n,r=t]=e;return[n,{...t,...r}]},n=Object.freeze((t=>{const e=new Set;let n=[];do{Object.getOwnPropertyNames(n).forEach((t=>{"function"==typeof n[t]&&e.add(t)}))}while((n=Object.getPrototypeOf(n))!==Object.prototype);return Array.from(e)})());!function(t,r,o,i,a,s,c,l,d,p,u=t,f){function h(){f||(f=1,"/"==(c=(s.lib||"/~partytown/")+(s.debug?"debug/":""))[0]&&(d=r.querySelectorAll('script[type="text/partytown"]'),i!=t?i.dispatchEvent(new CustomEvent("pt1",{detail:t})):(l=setTimeout(v,(null==s?void 0:s.fallbackTimeout)||1e4),r.addEventListener("pt0",w),a?y(1):o.serviceWorker?o.serviceWorker.register(c+(s.swPath||"partytown-sw.js"),{scope:c}).then((function(t){t.active?y():t.installing&&t.installing.addEventListener("statechange",(function(t){"activated"==t.target.state&&y()}))}),console.error):v())))}function y(e){p=r.createElement(e?"script":"iframe"),t._pttab=Date.now(),e||(p.style.display="block",p.style.width="0",p.style.height="0",p.style.border="0",p.style.visibility="hidden",p.setAttribute("aria-hidden",!0)),p.src=c+"partytown-"+(e?"atomics.js?v=0.11.2":"sandbox-sw.html?"+t._pttab),r.querySelector(s.sandboxParent||"body").appendChild(p)}function v(n,o){for(w(),i==t&&(s.forward||[]).map((function(n){const[r]=e(n);delete t[r.split(".")[0]]})),n=0;n<d.length;n++)(o=r.createElement("script")).innerHTML=d[n].innerHTML,o.nonce=s.nonce,r.head.appendChild(o);p&&p.parentNode.removeChild(p)}function w(){clearTimeout(l)}s=t.partytown||{},i==t&&(s.forward||[]).map((function(r){const[o,{preserveBehavior:i}]=e(r);u=t,o.split(".").map((function(e,r,o){var a;u=u[o[r]]=r+1<o.length?u[o[r]]||(a=o[r+1],n.includes(a)?[]:{}):(()=>{let e=null;if(i){const{methodOrProperty:n,thisObject:r}=((t,e)=>{let n=t;for(let t=0;t<e.length-1;t+=1)n=n[e[t]];return{thisObject:n,methodOrProperty:e.length>0?n[e[e.length-1]]:void 0}})(t,o);"function"==typeof n&&(e=(...t)=>n.apply(r,...t))}return function(){let n;return e&&(n=e(arguments)),(t._ptf=t._ptf||[]).push(o,arguments),n}})()}))})),"complete"==r.readyState?h():(t.addEventListener("DOMContentLoaded",h),t.addEventListener("load",h))}(window,document,navigator,top,window.crossOriginIsolated);;(e=>{e.addEventListener("astro:before-swap",e=>{let r=document.body.querySelector("iframe[src*='/~partytown/']");if(r)e.newDocument.body.append(r)})})(document);</script></head> <body class="text-foreground bg-background font-light dark:text-foreground-dark dark:bg-background-dark transition-colors"> <header class="fixed top-0 w-full z-40 bg-background dark:bg-background-dark"> <nav class=""> <div class="app-container flex justify-between items-center py-5"> <a href="/" aria-label="Home"> <svg width="36" height="36" viewBox="0 0 36 36" fill="none">
  <rect width="36" height="36" rx="8" fill="currentColor" opacity="0.1" />
  <text x="18" y="25" font-family="system-ui, -apple-system, sans-serif" font-size="18" font-weight="700" fill="currentColor" text-anchor="middle">PR</text>
</svg> </a> <div class="gap-8 hidden md:flex items-center"> <a href="/" class="text-lg" target="_self" data-astro-cid-rieiwi5x> Blog </a> <a href="https://github.com/sponsors/ghostdogpr" class="text-lg" target="_blank" data-astro-cid-rieiwi5x> Sponsor </a>  <div class="border-[1px] border-foreground dark:border-foreground-dark rounded-full flex justify-center items-center text-foreground dark:text-foreground-dark [&#38;>*:hover]:brightness-75 md:opacity-80 [&#38;>*]:cursor-pointer" data-astro-cid-lgn464si> <button data-theme="theme-auto" aria-label="Auto Theme" title="Set theme to follow system preference" class="theme-button theme-auto" data-astro-cid-lgn464si> <svg width="1em" height="1em" aria-hidden="true" data-astro-cid-lgn464si="true" class="duration-0 text-2xl md:text-xl" data-icon="mdi:brightness-auto">   <symbol id="ai:mdi:brightness-auto" viewBox="0 0 24 24"><path fill="currentColor" d="m14.3 16l-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69L8.69 4H4v4.69L.69 12L4 15.31V20h4.69L12 23.31L15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"/></symbol><use href="#ai:mdi:brightness-auto"></use>  </svg> </button> <button data-theme="theme-light" aria-label="Light Theme" title="Set theme to light" class="theme-button theme-light" data-astro-cid-lgn464si> <svg width="1em" height="1em" aria-hidden="true" data-astro-cid-lgn464si="true" class="duration-0 text-2xl md:text-xl" data-icon="mdi:white-balance-sunny">   <symbol id="ai:mdi:white-balance-sunny" viewBox="0 0 24 24"><path fill="currentColor" d="m3.55 19.09l1.41 1.41l1.8-1.79l-1.42-1.42M12 6c-3.31 0-6 2.69-6 6s2.69 6 6 6s6-2.69 6-6c0-3.32-2.69-6-6-6m8 7h3v-2h-3m-2.76 7.71l1.8 1.79l1.41-1.41l-1.79-1.8M20.45 5l-1.41-1.4l-1.8 1.79l1.42 1.42M13 1h-2v3h2M6.76 5.39L4.96 3.6L3.55 5l1.79 1.81zM1 13h3v-2H1m12 9h-2v3h2"/></symbol><use href="#ai:mdi:white-balance-sunny"></use>  </svg> </button> <button data-theme="theme-dark" aria-label="Dark Theme" title="Set theme to dark" class="theme-button theme-dark" data-astro-cid-lgn464si> <svg width="1em" height="1em" aria-hidden="true" data-astro-cid-lgn464si="true" class="duration-0 text-2xl md:text-xl" data-icon="mdi:moon-and-stars">   <symbol id="ai:mdi:moon-and-stars" viewBox="0 0 24 24"><path fill="currentColor" d="m17.75 4.09l-2.53 1.94l.91 3.06l-2.63-1.81l-2.63 1.81l.91-3.06l-2.53-1.94L12.44 4l1.06-3l1.06 3zm3.5 6.91l-1.64 1.25l.59 1.98l-1.7-1.17l-1.7 1.17l.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85c-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14c.4-.4.82-.76 1.27-1.08c.75-.53 1.93.36 1.85 1.19c-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82c-2.81 3.14-2.7 7.96.31 10.98c3.02 3.01 7.84 3.12 10.98.31"/></symbol><use href="#ai:mdi:moon-and-stars"></use>  </svg> </button> </div>  </div> <button class="md:hidden cursor-pointer" id="nav-open-btn" aria-label="Open navigation menu" title="Open navigation menu"> <svg width="32" height="32" aria-hidden="true" data-icon="mdi:menu">   <symbol id="ai:mdi:menu" viewBox="0 0 24 24"><path fill="currentColor" d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></symbol><use href="#ai:mdi:menu"></use>  </svg> </button> <!-- Mobile nav --> <div class="translate-x-full md:hidden fixed top-0 right-0 bg-background dark:bg-background-dark h-screen w-5/6 px-8 py-6 transition-transform z-40 border-l-[1px] border-background" id="mobile-menu"> <button id="nav-close-btn" class="ml-auto block cursor-pointer" aria-label="Close navigation menu" title="Close navigation menu"> <svg width="32" height="32" aria-hidden="true" data-icon="mdi:close">   <symbol id="ai:mdi:close" viewBox="0 0 24 24"><path fill="currentColor" d="M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12z"/></symbol><use href="#ai:mdi:close"></use>  </svg> </button> <div class="flex flex-col h-full items-start gap-8 pt-16"> <a href="/" class="text-4xl font-light" target="_self" data-astro-cid-rieiwi5x> Blog </a> <a href="https://github.com/sponsors/ghostdogpr" class="text-4xl font-light" target="_blank" data-astro-cid-rieiwi5x> Sponsor </a>  <div class="mt-4 border-[1px] border-foreground dark:border-foreground-dark rounded-full flex justify-center items-center text-foreground dark:text-foreground-dark [&#38;>*:hover]:brightness-75 md:opacity-80 [&#38;>*]:cursor-pointer" data-astro-cid-lgn464si> <button data-theme="theme-auto" aria-label="Auto Theme" title="Set theme to follow system preference" class="theme-button theme-auto" data-astro-cid-lgn464si> <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" data-astro-cid-lgn464si="true" class="duration-0 text-2xl md:text-xl" data-icon="mdi:brightness-auto">   <use href="#ai:mdi:brightness-auto"></use>  </svg> </button> <button data-theme="theme-light" aria-label="Light Theme" title="Set theme to light" class="theme-button theme-light" data-astro-cid-lgn464si> <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" data-astro-cid-lgn464si="true" class="duration-0 text-2xl md:text-xl" data-icon="mdi:white-balance-sunny">   <use href="#ai:mdi:white-balance-sunny"></use>  </svg> </button> <button data-theme="theme-dark" aria-label="Dark Theme" title="Set theme to dark" class="theme-button theme-dark" data-astro-cid-lgn464si> <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" data-astro-cid-lgn464si="true" class="duration-0 text-2xl md:text-xl" data-icon="mdi:moon-and-stars">   <use href="#ai:mdi:moon-and-stars"></use>  </svg> </button> </div>  </div> </div> </div> </nav> <script type="module">function e(){document.querySelector("#mobile-menu")?.classList.toggle("mobile-nav-open")}document.querySelector("#nav-open-btn")?.addEventListener("click",e);document.querySelector("#nav-close-btn")?.addEventListener("click",e);</script> </header> <script>
	function reComputeTheme() {
		if (
			localStorage.theme === 'dark' ||
			(!('theme' in localStorage) &&
				window.matchMedia('(prefers-color-scheme: dark)').matches)
		) {
			document.documentElement.classList.add('dark')
		} else {
			document.documentElement.classList.remove('dark')
		}

		const theme = localStorage.theme || 'auto'
		document
			.querySelectorAll(`[data-theme="theme-${theme}"]`)
			.forEach((el) => el.classList.add('active'))
	}

	function addThemeEventListeners() {
		themeButtons = document.querySelectorAll('.theme-button')
		themeButtons.forEach((button) => {
			button.addEventListener('click', () => {
				themeButtons.forEach((btn) => btn.classList.remove('active'))
				button.classList.add('active')
				if (button.dataset.theme === 'theme-auto') {
					localStorage.removeItem('theme')
					reComputeTheme()
				} else {
					localStorage.theme = button.dataset.theme.replace('theme-', '')
					document.documentElement.classList.toggle(
						'dark',
						button.dataset.theme === 'theme-dark'
					)
				}
			})
		})
	}

	// Set active class on OS theme change
	window
		.matchMedia('(prefers-color-scheme: dark)')
		.addEventListener('change', (_e) => {
			reComputeTheme()
		})

	// run recomputeTheme when screen crosses 768px
	window.matchMedia('(min-width: 768px)').addEventListener('change', (_e) => {
		addThemeEventListeners()
		reComputeTheme()
	})

	reComputeTheme()

	// Run on page load
	window.addEventListener('DOMContentLoaded', () => {
		addThemeEventListeners()
		reComputeTheme()
	})
</script>  <main> <article> <div class="app-container flex flex-col lg:flex-row-reverse justify-between gap-8 py-24 relative"> <div class="md:w-1/4 relative"> <div class="sticky top-0 md:top-28 hidden lg:block"> <nav class="py-12 rounded"><h2 class="text-2xl mr-2 pb-1 mb-3 font-bold">On This Page</h2><ul class="space-y-3"><li><a class="hover:underline underline-offset-4" href="#runtime-flags">Runtime flags</a></li><li><a class="hover:underline underline-offset-4" href="#parallelism">Parallelism</a></li><li><a class="hover:underline underline-offset-4" href="#executors">Executors</a><ul class="ml-4 mt-2 space-y-2 border-l border-gray-300 dark:border-gray-700 pl-4"><li><a class="hover:underline underline-offset-4 text-sm opacity-80" href="#blocking">Blocking</a></li><li><a class="hover:underline underline-offset-4 text-sm opacity-80" href="#executor-override">Executor override</a></li><li><a class="hover:underline underline-offset-4 text-sm opacity-80" href="#alternative-executors">Alternative executors</a></li><li><a class="hover:underline underline-offset-4 text-sm opacity-80" href="#a-final-note-on-datadog">A final note on Datadog</a></li></ul></li></ul></nav> </div> </div> <div class="grow w-full md:max-w-[75ch]"> <div> <h1 class="text-4xl sm:text-5xl leading-snug pt-12 font-bold"> Tuning ZIO for high performance </h1> <div class="text-lg flex items-center gap-4 flex-wrap py-8"> <!-- Publish date --> <span> <svg width="1em" height="1em" class="inline-block text-primary dark:text-primary-dark" data-icon="mdi:calendar-month-outline">   <symbol id="ai:mdi:calendar-month-outline" viewBox="0 0 24 24"><path fill="currentColor" d="M7 11h2v2H7zm14-6v14c0 1.11-.89 2-2 2H5a2 2 0 0 1-2-2V5c0-1.1.9-2 2-2h1V1h2v2h8V1h2v2h1a2 2 0 0 1 2 2M5 7h14V5H5zm14 12V9H5v10zm-4-6v-2h2v2zm-4 0v-2h2v2zm-4 2h2v2H7zm8 2v-2h2v2zm-4 0v-2h2v2z"/></symbol><use href="#ai:mdi:calendar-month-outline"></use>  </svg> <time datetime="2024-05-13T00:00:00.000Z"> 13 May 2024 </time> </span> <!-- Updated date -->  <!-- Read time --> <span> <svg width="1em" height="1em" class="inline-block text-primary dark:text-primary-dark" data-icon="mdi:clock-time-four-outline">   <symbol id="ai:mdi:clock-time-four-outline" viewBox="0 0 24 24"><path fill="currentColor" d="M12 20c4.4 0 8-3.6 8-8s-3.6-8-8-8s-8 3.6-8 8s3.6 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10S2 17.5 2 12S6.5 2 12 2m5 11.9l-.7 1.3l-5.3-2.9V7h1.5v4.4z"/></symbol><use href="#ai:mdi:clock-time-four-outline"></use>  </svg> 11 min read </span> </div>  <img src="/_astro/cover.DyPoWoUg_AsKBy.webp" alt="Tuning ZIO for high performance" loading="lazy" decoding="async" fetchpriority="auto" width="853" height="480" class="rounded-lg mb-8">  </div> <div class="prose prose-neutral prose-lg md:prose-xl dark:prose-invert prose-img:rounded-xl prose-figure:text-center prose-img:mx-auto">  <p>Let’s start with a disclaimer. What is discussed in this article is not the ultimate truth: how to make your application faster highly depends on what your application is actually doing. Depending on your use case, the overhead of ZIO might be completely negligible, or on the other hand, it might be quite significant. The only way to know is to analyze and measure the performance of your application through load testing with a profiler. However, I hope to provide some interesting pointers and things to consider when taking your ZIO app to production.</p>
<h2 id="runtime-flags">Runtime flags</h2>
<p>Let’s start with an easy one. ZIO has a few flags that can be easily turned on or off when you run your application. I won’t detail all of them, but I want to draw your attention to two of them that can have some impact in production.</p>
<p>The first one is called <code>FiberRoots</code> and is enabled by default. With this flag on, whenever a root fiber is created (usually using the <code>forkDaemon</code> operator), this fiber will be added to a list tracking all root fibers. This mechanism serves two purposes:</p>
<ul>
<li>
<p>You can perform fiber dumps. Similarly to thread dumps, you can send <code>kill -s INFO</code> to your application process, and it will print the full list of root fibers, their state, and what they are currently doing (which function they are executing).</p>
</li>
<li>
<p>When you stop your application, ZIO will try to interrupt all root fibers. If you don’t track them, it will only interrupt the “children” fibers created from the main fiber, but you won’t have clean termination of other root fibers created through <code>forkDaemon</code>.</p>
</li>
</ul>
<p>However, this kind of tracking has a cost if you are creating a lot of root fibers. In the most extreme use case where we are just forking root fibers that do nothing, disabling the <code>FiberRoots</code> flag improves performance by 2.5 times (see the benchmark result in <a href="https://github.com/zio/zio/pull/8745">https://github.com/zio/zio/pull/8745</a>). Be aware that even if you don’t have many <code>forkDaemon</code> in your own code, it might be called by a library you are using. For example, zio-grpc calls <code>forkDaemon</code><a href="https://github.com/scalapb/zio-grpc/blob/25c467156110b11ee520d9925fbb7a50013c70eb/core/src/main/scalajvm/scalapb/zio_grpc/server/ListenerDriver.scala#L38">on every gRPC request</a>. Some ZIO operators also use it internally.</p>
<p>Personally, while I occasionally use fiber dumps in my local environment, I don’t really need them in production, so I disabled that flag to avoid doing that tracking unnecessarily. Disabling it can be done by simply adding this to the <code>bootstrap</code> function of your ZIO app:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="scala"><code><span class="line"><span style="color:#F97583">val</span><span style="color:#FFAB70"> bootstrap</span><span style="color:#F97583"> =</span><span style="color:#B392F0"> Runtime</span><span style="color:#E1E4E8">.disableFlags(</span><span style="color:#B392F0">RuntimeFlag</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">FiberRoots</span><span style="color:#E1E4E8">)</span></span></code></pre>
<p>There is another flag that I find quite interesting, and that one is disabled by default: <code>RuntimeMetrics</code>. Enabling that flag will trigger the collection of metrics that are then exposed as ZIO metrics and can be sent to the backend of your choice (Prometheus, Datadog, etc). The metrics it collects are the following:</p>
<ul>
<li>
<p><code>zio_fiber_failure_causes</code> will collect the common causes of fiber failures</p>
</li>
<li>
<p><code>zio_fiber_fork_locations</code> will tell you from where in the code you fork fibers the most</p>
</li>
<li>
<p><code>zio_fiber_started</code>, <code>zio_fiber_successes</code>, and <code>zio_fiber_failures</code> will count how many fibers are started and how many succeed or fail</p>
</li>
<li>
<p><code>zio_fiber_lifetimes</code> will measure how long your fibers are running</p>
</li>
</ul>
<p>Having those metrics can be quite useful when monitoring a production system, so you might want to consider it despite its runtime overhead. That overhead should be pretty small, but again, test and measure before you apply it.</p>
<p>Enabling it can be done by adding the following in your <code>bootstrap</code> function:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="scala"><code><span class="line"><span style="color:#F97583">val</span><span style="color:#FFAB70"> boostrap</span><span style="color:#F97583"> =</span><span style="color:#B392F0"> Runtime</span><span style="color:#E1E4E8">.enableRuntimeMetrics</span></span></code></pre>
<h2 id="parallelism">Parallelism</h2>
<p>Let’s now talk about a common pitfall when using ZIO: unbounded parallelism. One of ZIO’s common operators is <code>ZIO.foreach</code>, which allows you to run an effect for each item in a collection. There’s also <code>ZIO.foreachDiscard</code> that is faster if you don’t need to collect results (e.g., if your effect returns <code>Unit</code>). These operators have parallel counterparts: <code>ZIO.foreachPar</code> and <code>ZIO.foreachParDiscard</code> when you want to run things in parallel.</p>
<p>However, in some situations, <code>foreachPar</code> can be slower than <code>foreach</code>. How is that possible?</p>
<p>If you run <code>foreachPar</code> on a collection of 1,000 elements, ZIO is going to create 1,000 fibers that are all going to compete for your CPU time. If what each fiber does is CPU-bound, there is no advantage in creating more fibers than your number of cores. On the contrary, you are going to suffer from the overhead of the machinery involved with creating and joining all those fibers. In cases where your fibers are doing some I/O, it might make sense to create a lot of them at once, but you are most probably going to hit some other limits (e.g., DB connections, network, etc.), so making it bounded can be safer.</p>
<p>To control the number of fibers created when using <code>foreachPar</code>, you can use the <code>withParallelism</code> operator on <code>ZIO</code>.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="scala"><code><span class="line"><span style="color:#B392F0">ZIO</span></span>
<span class="line"><span style="color:#E1E4E8">  .foreachPar(</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8"> to </span><span style="color:#79B8FF">1000</span><span style="color:#E1E4E8">)(_ </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> doSomething)</span></span>
<span class="line"><span style="color:#E1E4E8">  .withParallelism(</span><span style="color:#79B8FF">16</span><span style="color:#E1E4E8">)</span></span></code></pre>
<p>In that example, 16 fibers will be created and will concurrently process elements from <code>myList</code>. Assuming <code>doSomething</code> is CPU-bound and I have 16 cores, this will perform much better than having 1,000 fibers doing the same thing.</p>
<p>The <code>withParallelism</code> operator adjusts the parallelism level for any code executed within its scope. This includes all child fibers forked from it, as fibers inherit this setting from their parent. This means you can use <code>withParallelism</code> in your main function to set a sensible default parallelism across your application (usually matching the number of CPU cores), and you can adjust it locally as needed.</p>
<p>Fun fact: while writing this, I checked the implementation of <code>foreachPar</code> and realized that when using <code>withParallelism</code> with a number <code>n</code> that was <em>higher</em> than the size of the collection, we were still creating <code>n</code> fibers. This is unnecessary because we only need to create as many fibers as there are items in the collection. I <a href="https://github.com/zio/zio/pull/8847">opened a PR</a> to optimize this behavior, and it should be available in the next minor release of ZIO.</p>
<h2 id="executors">Executors</h2>
<p>When creating fibers and giving them work to do, these tasks eventually end up running on physical threads. In ZIO, the logic for creating those threads and assigning tasks to them in a way that maximizes CPU efficiency is the job of the <em>executor</em>. Let’s explore the different options we have here.</p>
<p>As of ZIO 2.1.0, the default executor is called <code>ZScheduler</code> and it is essentially a port of the Tokio scheduler in Rust. <a href="https://tokio.rs/blog/2019-10-scheduler">This article</a> explains the algorithm in detail, but to summarize it very roughly:</p>
<ul>
<li>
<p>We create a number of threads equal to the number of cores we have available.</p>
</li>
<li>
<p>Each thread has a local queue of tasks to run, and there is also a global queue that is shared between all threads.</p>
</li>
<li>
<p>When a fiber forks an effect, we create a new fiber and enqueue it into the local queue of the current thread. If the current thread isn’t a ZIO thread (for example, if we call <code>unsafe.run</code> from an external thread), we enqueue it into the global queue. If the local queue is full (its size is bounded), we take half of its tasks and move them to the global queue.</p>
</li>
<li>
<p>We then check if there is a thread sleeping, and wake it up if we find one.</p>
</li>
<li>
<p>When waking up, or also when they finish their current task, threads will find the next task to do this way:</p>
<ul>
<li>
<p>pick from their local queue first</p>
</li>
<li>
<p>if it is empty, pick from the global queue</p>
</li>
<li>
<p>if it is empty, look at other threads’ local queues to see if there is anything to steal. When stealing, a thread takes half of the other thread’s local queue.</p>
</li>
</ul>
</li>
</ul>
<p>This process is proven and has been working efficiently since ZIO 2 was released. It has even been <a href="https://github.com/zio/zio/pull/8745">recently improved</a> in ZIO 2.1. Why would we change it? Let’s find out.</p>
<h3 id="blocking">Blocking</h3>
<p>In ZIO 2.0.x, the default scheduler had a feature called auto-blocking enabled by default. In 2.1.x, it has been disabled and requires explicit opt-in:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="scala"><code><span class="line"><span style="color:#F97583">val</span><span style="color:#FFAB70"> bootstrap</span><span style="color:#F97583"> =</span><span style="color:#B392F0"> Runtime</span><span style="color:#E1E4E8">.enableAutoBlockingExecutor</span></span></code></pre>
<p>What this does is that it tries to detect if a fiber is running a blocking task, and when it does, it remembers from which part of the code it came from in order to shift it to the blocking threadpool automatically afterward. The goal is that if users forget to wrap their blocking code in <code>ZIO.blocking</code> or <code>ZIO.attemptBlocking</code>, the executor will do it for them.</p>
<p>Running blocking code on the default executor is bad because it uses a limited number of threads, and you can easily end up with all your threads blocked and no work being done at all.</p>
<p>The issue with this behavior is that the detection of whether a fiber is running blocking code is a heuristic that is not perfect and can detect false positives. To make it short, a task is considered “blocking” if its execution takes longer than a certain threshold. But that doesn’t actually mean that it’s blocking; it could just be CPU-bound, or it could be slow for another reason (I’ve witnessed my code being shifted to the blocking threadpool because class loading was taking some time at startup while the JVM was cold). Another issue is that tracking the blocking locations and checking it every time we run a task introduces overhead.</p>
<p>To get the best performance possible, it is better not to use this mode and to explicitly shift blocking code to the blocking threadpool. If you have doubts, use a profiler to look at thread states and find potential blocking. If you are not confident about your own code or the libraries you use and you are ready to take the performance penalty for better safety, then it is a perfectly fine option to enable auto-blocking.</p>
<h3 id="executor-override">Executor override</h3>
<p>There is a behavior in ZIO that can be quite surprising and that not many people know about: when you shift a task to the blocking threadpool, the fiber does not automatically return to the default executor after running that code. It stays in the blocking threadpool until the fiber ends or it executes enough run loops to yield back to the default executor.</p>
<p>Depending on your use case, that behavior might be good or bad: if your fibers immediately end after doing the blocking call (for example, making a DB call and returning it to the client), it is more efficient to avoid the thread shifting. However, if your fibers are long-lived (for example, an entity behavior in <a href="https://github.com/devsisters/shardcake">Shardcake</a>), you’re going to have a lot of code running on the blocking threadpool, which might result in a large number of threads and a loss of performance. I believe <a href="https://github.com/typelevel/cats-effect">Cats Effect</a> made a different choice and automatically shifts back by default.</p>
<p>There is a simple way to fix this, though, which is setting an executor explicitly. When you override the default executor, work will always shift back to that given executor after the blocking code is executed. But what if you want to keep the default executor? Well, you can override the default executor with itself!</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="scala"><code><span class="line"><span style="color:#F97583">val</span><span style="color:#FFAB70"> bootstrap</span><span style="color:#F97583"> =</span></span>
<span class="line"><span style="color:#B392F0">  Runtime</span><span style="color:#E1E4E8">.setExecutor(</span><span style="color:#B392F0">Executor</span><span style="color:#E1E4E8">.makeDefault(autoBlocking </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> false</span><span style="color:#E1E4E8">))</span></span></code></pre>
<p>That simple line will guarantee that you always shift back to the default executor after running blocking code.</p>
<p><strong>Edit (2024/06/25):</strong> Since ZIO 2.1.2, there is now a flag that lets you control whether to shift back to the previous executor after blocking. Instead of the workaround above, you can do this:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="scala"><code><span class="line"><span style="color:#F97583">val</span><span style="color:#FFAB70"> boostrap</span><span style="color:#F97583"> =</span></span>
<span class="line"><span style="color:#B392F0">   Runtime</span><span style="color:#E1E4E8">.enableFlags(</span><span style="color:#B392F0">RuntimeFlag</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">EagerShiftBack</span><span style="color:#E1E4E8">)</span></span></code></pre>
<h3 id="alternative-executors">Alternative executors</h3>
<p>Another reason to change the default executor could be to try brand new, alternative executors. First, there is a new executor in ZIO 2.1.x that uses Loom (therefore is only available on JDK21+) and assigns virtual threads to each fiber’s work. The efficiency of running those virtual threads on actual threads is then left to Loom.</p>
<p>To use it, simply add this to your <code>bootstrap</code> function:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="scala"><code><span class="line"><span style="color:#F97583">val</span><span style="color:#FFAB70"> bootstrap</span><span style="color:#F97583"> =</span><span style="color:#B392F0"> Runtime</span><span style="color:#E1E4E8">.enableLoomBasedExecutor</span></span></code></pre>
<p>This is an interesting alternative that you should definitely test. However, note that in the ZIO benchmark that tests creating and joining a lot of fibers, the default Tokio-based scheduler was quite a lot faster than the Loom-based one.</p>
<p>Another recent possibility is Kyo’s scheduler, which has been recently extracted as a standalone dependency in <a href="https://github.com/getkyo/kyo/releases/tag/v0.9.3">kyo 0.9.3</a>. It is very new, so don’t expect something battle-tested yet; however, its creator <a href="https://twitter.com/fbrasisil">Flavio Brasil</a> is an expert on the matter, and his scheduler is based on years of experience working with various effect systems on the JVM. I am definitely planning to give it a try at some point in the future.</p>
<h3 id="a-final-note-on-datadog">A final note on Datadog</h3>
<p>I’ll finish with a last tip for people using Datadog, which provides an agent that automatically <a href="https://docs.datadoghq.com/profiler/">profiles your code</a> without any significant overhead. There are 2 flags related to ZIO that I changed in production:</p>
<ul>
<li>
<p><code>-Ddd.integration.throwables.enabled=false</code> disables exception profiling. Why would we need that? From version 2.0.x, ZIO uses exceptions for control flow internally. It means that we’re going to have a very high number of exceptions which can overwhelm the profiler. In ZIO 2.1.x, these usages have decreased but were not totally removed so it is still relevant.</p>
</li>
<li>
<p><code>-Ddd.integration.zio.experimental.enabled=true</code> won’t improve performance but it will allow the Datadog tracer to be able to pass its context between ZIO fibers. This should give you much better traces as it will be able to attach DB calls to API calls, for example. I’ve been using it in production for a while and can confirm there is no overhead. Despite its experimental status (and I believe its absence from the official documentation), it has been working well so I recommend it.</p>
</li>
</ul>
<p>That’s it for today! I hope that was helpful.</p>
<p>Got additional tips for making ZIO applications faster in production? Let me know about it in the comments!</p>  </div> </div> </div> </article> </main>  <footer> <div class="app-container grid md:grid-cols-3 gap-12 py-16 border-t-2 border-foreground/50 dark:border-foreground-dark/50"> <div> <a href="/" class="block w-fit" aria-label="Home"> <svg width="36" height="36" viewBox="0 0 36 36" fill="none">
  <rect width="36" height="36" rx="8" fill="currentColor" opacity="0.1" />
  <text x="18" y="25" font-family="system-ui, -apple-system, sans-serif" font-size="18" font-weight="700" fill="currentColor" text-anchor="middle">PR</text>
</svg> </a> </div> <div> <h3 class="font-semibold text-2xl">Links</h3> <div class="flex flex-wrap gap-4 mt-4"> <a class="text-lg" href target="_blank" rel="noopener noreferrer"> Blog </a><a class="text-lg" href="https://github.com/sponsors/ghostdogpr" target="_blank" rel="noopener noreferrer"> Sponsor </a> <a href="/rss.xml" target="_blank" rel="noopener noreferrer" class="text-lg" aria-label="RSS Feed"> <svg width="1em" height="1em" class="w-6 h-6" data-icon="mdi:rss">   <symbol id="ai:mdi:rss" viewBox="0 0 24 24"><path fill="currentColor" d="M6.18 15.64a2.18 2.18 0 0 1 2.18 2.18C8.36 19 7.38 20 6.18 20C5 20 4 19 4 17.82a2.18 2.18 0 0 1 2.18-2.18M4 4.44A15.56 15.56 0 0 1 19.56 20h-2.83A12.73 12.73 0 0 0 4 7.27zm0 5.66a9.9 9.9 0 0 1 9.9 9.9h-2.83A7.07 7.07 0 0 0 4 12.93z"/></symbol><use href="#ai:mdi:rss"></use>  </svg> </a> </div> </div> <div> <h3 class="font-semibold text-2xl">Socials</h3> <div class="flex flex-wrap gap-4 mt-4"> <a class="text-lg" href="https://github.com/ghostdogpr" target="_blank" rel="noopener noreferrer"> GitHub </a><a class="text-lg" href="https://www.linkedin.com/in/pierrericadat/" target="_blank" rel="noopener noreferrer"> LinkedIn </a><a class="text-lg" href="https://twitter.com/ghostdogpr" target="_blank" rel="noopener noreferrer"> X / Twitter </a> </div> </div> </div> <div class="app-container flex justify-between items-center pb-6 text-center"> <p class="text-left md:text-center w-full">
Theme: <a class="underline" href="https://github.com/yashjawale/saral-theme-astro" target="_blank">Saral</a> </p> </div> </footer> </body></html>
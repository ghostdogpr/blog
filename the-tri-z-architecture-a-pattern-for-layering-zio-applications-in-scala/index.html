<!DOCTYPE html><html lang="en"> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="generator" content="Astro v5.13.7"><!-- Favicons --><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="apple-mobile-web-app-title" content="Pierre Ricadat's Tech Blog"><!-- Canonical URL --><link rel="canonical" href="https://blog.pierre-ricadat.com/the-tri-z-architecture-a-pattern-for-layering-zio-applications-in-scala/"><!-- Primary Meta Tags --><title>The Tri-Z Architecture: a Pattern for Layering ZIO Applications in Scala</title><meta name="title" content="The Tri-Z Architecture: a Pattern for Layering ZIO Applications in Scala"><meta name="description" content="After working on several different services and spending a lot of time improving the code to make it easier to use, I discovered a pattern for layering my ap...
"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://blog.pierre-ricadat.com/the-tri-z-architecture-a-pattern-for-layering-zio-applications-in-scala/"><meta property="og:title" content="The Tri-Z Architecture: a Pattern for Layering ZIO Applications in Scala"><meta property="og:description" content="After working on several different services and spending a lot of time improving the code to make it easier to use, I discovered a pattern for layering my ap...
"><meta property="og:image" content="https://blog.pierre-ricadat.com/saral-og.jpg"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://blog.pierre-ricadat.com/the-tri-z-architecture-a-pattern-for-layering-zio-applications-in-scala/"><meta property="twitter:title" content="The Tri-Z Architecture: a Pattern for Layering ZIO Applications in Scala"><meta property="twitter:description" content="After working on several different services and spending a lot of time improving the code to make it easier to use, I discovered a pattern for layering my ap...
"><meta property="twitter:image" content="https://blog.pierre-ricadat.com/saral-og.jpg"><!-- RSS Auto-discovery --><link rel="alternate" type="application/rss+xml" title="Pierre Ricadat's Tech Blog RSS Feed" href="https://blog.pierre-ricadat.com/rss.xml"><link rel="stylesheet" href="/_astro/_slug_.DSRIcTml.css"><script>!(function(w,p,f,c){if(!window.crossOriginIsolated && !navigator.serviceWorker) return;c=w[p]=Object.assign(w[p]||{},{"lib":"/~partytown/","debug":false});c[f]=(c[f]||[]).concat(["dataLayer.push"])})(window,'partytown','forward');/* Partytown 0.11.2 - MIT QwikDev */
const t={preserveBehavior:!1},e=e=>{if("string"==typeof e)return[e,t];const[n,r=t]=e;return[n,{...t,...r}]},n=Object.freeze((t=>{const e=new Set;let n=[];do{Object.getOwnPropertyNames(n).forEach((t=>{"function"==typeof n[t]&&e.add(t)}))}while((n=Object.getPrototypeOf(n))!==Object.prototype);return Array.from(e)})());!function(t,r,o,i,a,s,c,l,d,p,u=t,f){function h(){f||(f=1,"/"==(c=(s.lib||"/~partytown/")+(s.debug?"debug/":""))[0]&&(d=r.querySelectorAll('script[type="text/partytown"]'),i!=t?i.dispatchEvent(new CustomEvent("pt1",{detail:t})):(l=setTimeout(v,(null==s?void 0:s.fallbackTimeout)||1e4),r.addEventListener("pt0",w),a?y(1):o.serviceWorker?o.serviceWorker.register(c+(s.swPath||"partytown-sw.js"),{scope:c}).then((function(t){t.active?y():t.installing&&t.installing.addEventListener("statechange",(function(t){"activated"==t.target.state&&y()}))}),console.error):v())))}function y(e){p=r.createElement(e?"script":"iframe"),t._pttab=Date.now(),e||(p.style.display="block",p.style.width="0",p.style.height="0",p.style.border="0",p.style.visibility="hidden",p.setAttribute("aria-hidden",!0)),p.src=c+"partytown-"+(e?"atomics.js?v=0.11.2":"sandbox-sw.html?"+t._pttab),r.querySelector(s.sandboxParent||"body").appendChild(p)}function v(n,o){for(w(),i==t&&(s.forward||[]).map((function(n){const[r]=e(n);delete t[r.split(".")[0]]})),n=0;n<d.length;n++)(o=r.createElement("script")).innerHTML=d[n].innerHTML,o.nonce=s.nonce,r.head.appendChild(o);p&&p.parentNode.removeChild(p)}function w(){clearTimeout(l)}s=t.partytown||{},i==t&&(s.forward||[]).map((function(r){const[o,{preserveBehavior:i}]=e(r);u=t,o.split(".").map((function(e,r,o){var a;u=u[o[r]]=r+1<o.length?u[o[r]]||(a=o[r+1],n.includes(a)?[]:{}):(()=>{let e=null;if(i){const{methodOrProperty:n,thisObject:r}=((t,e)=>{let n=t;for(let t=0;t<e.length-1;t+=1)n=n[e[t]];return{thisObject:n,methodOrProperty:e.length>0?n[e[e.length-1]]:void 0}})(t,o);"function"==typeof n&&(e=(...t)=>n.apply(r,...t))}return function(){let n;return e&&(n=e(arguments)),(t._ptf=t._ptf||[]).push(o,arguments),n}})()}))})),"complete"==r.readyState?h():(t.addEventListener("DOMContentLoaded",h),t.addEventListener("load",h))}(window,document,navigator,top,window.crossOriginIsolated);;(e=>{e.addEventListener("astro:before-swap",e=>{let r=document.body.querySelector("iframe[src*='/~partytown/']");if(r)e.newDocument.body.append(r)})})(document);</script></head> <body class="text-foreground bg-background font-light dark:text-foreground-dark dark:bg-background-dark transition-colors"> <header class="fixed top-0 w-full z-40 bg-background dark:bg-background-dark"> <nav class=""> <div class="app-container flex justify-between items-center py-5"> <a href="/" aria-label="Home"> <svg width="36" height="36" viewBox="0 0 36 36" fill="none">
  <rect width="36" height="36" rx="8" fill="currentColor" opacity="0.1" />
  <text x="18" y="25" font-family="system-ui, -apple-system, sans-serif" font-size="18" font-weight="700" fill="currentColor" text-anchor="middle">PR</text>
</svg> </a> <div class="gap-8 hidden md:flex items-center"> <a href="/" class="text-lg" target="_self" data-astro-cid-rieiwi5x> Blog </a> <a href="https://github.com/sponsors/ghostdogpr" class="text-lg" target="_blank" data-astro-cid-rieiwi5x> Sponsor </a>  <div class="border-[1px] border-foreground dark:border-foreground-dark rounded-full flex justify-center items-center text-foreground dark:text-foreground-dark [&#38;>*:hover]:brightness-75 md:opacity-80 [&#38;>*]:cursor-pointer" data-astro-cid-lgn464si> <button data-theme="theme-auto" aria-label="Auto Theme" title="Set theme to follow system preference" class="theme-button theme-auto" data-astro-cid-lgn464si> <svg width="1em" height="1em" aria-hidden="true" data-astro-cid-lgn464si="true" class="duration-0 text-2xl md:text-xl" data-icon="mdi:brightness-auto">   <symbol id="ai:mdi:brightness-auto" viewBox="0 0 24 24"><path fill="currentColor" d="m14.3 16l-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69L8.69 4H4v4.69L.69 12L4 15.31V20h4.69L12 23.31L15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"/></symbol><use href="#ai:mdi:brightness-auto"></use>  </svg> </button> <button data-theme="theme-light" aria-label="Light Theme" title="Set theme to light" class="theme-button theme-light" data-astro-cid-lgn464si> <svg width="1em" height="1em" aria-hidden="true" data-astro-cid-lgn464si="true" class="duration-0 text-2xl md:text-xl" data-icon="mdi:white-balance-sunny">   <symbol id="ai:mdi:white-balance-sunny" viewBox="0 0 24 24"><path fill="currentColor" d="m3.55 19.09l1.41 1.41l1.8-1.79l-1.42-1.42M12 6c-3.31 0-6 2.69-6 6s2.69 6 6 6s6-2.69 6-6c0-3.32-2.69-6-6-6m8 7h3v-2h-3m-2.76 7.71l1.8 1.79l1.41-1.41l-1.79-1.8M20.45 5l-1.41-1.4l-1.8 1.79l1.42 1.42M13 1h-2v3h2M6.76 5.39L4.96 3.6L3.55 5l1.79 1.81zM1 13h3v-2H1m12 9h-2v3h2"/></symbol><use href="#ai:mdi:white-balance-sunny"></use>  </svg> </button> <button data-theme="theme-dark" aria-label="Dark Theme" title="Set theme to dark" class="theme-button theme-dark" data-astro-cid-lgn464si> <svg width="1em" height="1em" aria-hidden="true" data-astro-cid-lgn464si="true" class="duration-0 text-2xl md:text-xl" data-icon="mdi:moon-and-stars">   <symbol id="ai:mdi:moon-and-stars" viewBox="0 0 24 24"><path fill="currentColor" d="m17.75 4.09l-2.53 1.94l.91 3.06l-2.63-1.81l-2.63 1.81l.91-3.06l-2.53-1.94L12.44 4l1.06-3l1.06 3zm3.5 6.91l-1.64 1.25l.59 1.98l-1.7-1.17l-1.7 1.17l.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85c-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14c.4-.4.82-.76 1.27-1.08c.75-.53 1.93.36 1.85 1.19c-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82c-2.81 3.14-2.7 7.96.31 10.98c3.02 3.01 7.84 3.12 10.98.31"/></symbol><use href="#ai:mdi:moon-and-stars"></use>  </svg> </button> </div>  </div> <button class="md:hidden cursor-pointer" id="nav-open-btn" aria-label="Open navigation menu" title="Open navigation menu"> <svg width="32" height="32" aria-hidden="true" data-icon="mdi:menu">   <symbol id="ai:mdi:menu" viewBox="0 0 24 24"><path fill="currentColor" d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></symbol><use href="#ai:mdi:menu"></use>  </svg> </button> <!-- Mobile nav --> <div class="translate-x-full md:hidden fixed top-0 right-0 bg-background dark:bg-background-dark h-screen w-5/6 px-8 py-6 transition-transform z-40 border-l-[1px] border-background" id="mobile-menu"> <button id="nav-close-btn" class="ml-auto block cursor-pointer" aria-label="Close navigation menu" title="Close navigation menu"> <svg width="32" height="32" aria-hidden="true" data-icon="mdi:close">   <symbol id="ai:mdi:close" viewBox="0 0 24 24"><path fill="currentColor" d="M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12z"/></symbol><use href="#ai:mdi:close"></use>  </svg> </button> <div class="flex flex-col h-full items-start gap-8 pt-16"> <a href="/" class="text-4xl font-light" target="_self" data-astro-cid-rieiwi5x> Blog </a> <a href="https://github.com/sponsors/ghostdogpr" class="text-4xl font-light" target="_blank" data-astro-cid-rieiwi5x> Sponsor </a>  <div class="mt-4 border-[1px] border-foreground dark:border-foreground-dark rounded-full flex justify-center items-center text-foreground dark:text-foreground-dark [&#38;>*:hover]:brightness-75 md:opacity-80 [&#38;>*]:cursor-pointer" data-astro-cid-lgn464si> <button data-theme="theme-auto" aria-label="Auto Theme" title="Set theme to follow system preference" class="theme-button theme-auto" data-astro-cid-lgn464si> <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" data-astro-cid-lgn464si="true" class="duration-0 text-2xl md:text-xl" data-icon="mdi:brightness-auto">   <use href="#ai:mdi:brightness-auto"></use>  </svg> </button> <button data-theme="theme-light" aria-label="Light Theme" title="Set theme to light" class="theme-button theme-light" data-astro-cid-lgn464si> <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" data-astro-cid-lgn464si="true" class="duration-0 text-2xl md:text-xl" data-icon="mdi:white-balance-sunny">   <use href="#ai:mdi:white-balance-sunny"></use>  </svg> </button> <button data-theme="theme-dark" aria-label="Dark Theme" title="Set theme to dark" class="theme-button theme-dark" data-astro-cid-lgn464si> <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" data-astro-cid-lgn464si="true" class="duration-0 text-2xl md:text-xl" data-icon="mdi:moon-and-stars">   <use href="#ai:mdi:moon-and-stars"></use>  </svg> </button> </div>  </div> </div> </div> </nav> <script type="module">function e(){document.querySelector("#mobile-menu")?.classList.toggle("mobile-nav-open")}document.querySelector("#nav-open-btn")?.addEventListener("click",e);document.querySelector("#nav-close-btn")?.addEventListener("click",e);</script> </header> <script>
	function reComputeTheme() {
		if (
			localStorage.theme === 'dark' ||
			(!('theme' in localStorage) &&
				window.matchMedia('(prefers-color-scheme: dark)').matches)
		) {
			document.documentElement.classList.add('dark')
		} else {
			document.documentElement.classList.remove('dark')
		}

		const theme = localStorage.theme || 'auto'
		document
			.querySelectorAll(`[data-theme="theme-${theme}"]`)
			.forEach((el) => el.classList.add('active'))
	}

	function addThemeEventListeners() {
		themeButtons = document.querySelectorAll('.theme-button')
		themeButtons.forEach((button) => {
			button.addEventListener('click', () => {
				themeButtons.forEach((btn) => btn.classList.remove('active'))
				button.classList.add('active')
				if (button.dataset.theme === 'theme-auto') {
					localStorage.removeItem('theme')
					reComputeTheme()
				} else {
					localStorage.theme = button.dataset.theme.replace('theme-', '')
					document.documentElement.classList.toggle(
						'dark',
						button.dataset.theme === 'theme-dark'
					)
				}
			})
		})
	}

	// Set active class on OS theme change
	window
		.matchMedia('(prefers-color-scheme: dark)')
		.addEventListener('change', (_e) => {
			reComputeTheme()
		})

	// run recomputeTheme when screen crosses 768px
	window.matchMedia('(min-width: 768px)').addEventListener('change', (_e) => {
		addThemeEventListeners()
		reComputeTheme()
	})

	reComputeTheme()

	// Run on page load
	window.addEventListener('DOMContentLoaded', () => {
		addThemeEventListeners()
		reComputeTheme()
	})
</script>  <main> <article> <div class="app-container flex flex-col lg:flex-row-reverse justify-between gap-8 py-24 relative"> <div class="md:w-1/4 relative"> <div class="sticky top-0 md:top-28 hidden lg:block"> <div></div> </div> </div> <div class="grow w-full md:max-w-[75ch]"> <div> <h1 class="text-4xl sm:text-5xl leading-snug pt-12 font-bold"> The Tri-Z Architecture: a Pattern for Layering ZIO Applications in Scala </h1> <div class="text-lg flex items-center gap-4 flex-wrap py-8"> <!-- Publish date --> <span> <svg width="1em" height="1em" class="inline-block text-primary dark:text-primary-dark" data-icon="mdi:calendar-month-outline">   <symbol id="ai:mdi:calendar-month-outline" viewBox="0 0 24 24"><path fill="currentColor" d="M7 11h2v2H7zm14-6v14c0 1.11-.89 2-2 2H5a2 2 0 0 1-2-2V5c0-1.1.9-2 2-2h1V1h2v2h8V1h2v2h1a2 2 0 0 1 2 2M5 7h14V5H5zm14 12V9H5v10zm-4-6v-2h2v2zm-4 0v-2h2v2zm-4 2h2v2H7zm8 2v-2h2v2zm-4 0v-2h2v2z"/></symbol><use href="#ai:mdi:calendar-month-outline"></use>  </svg> <time datetime="2024-08-05T00:00:00.000Z"> 5 Aug 2024 </time> </span> <!-- Updated date -->  <!-- Read time --> <span> <svg width="1em" height="1em" class="inline-block text-primary dark:text-primary-dark" data-icon="mdi:clock-time-four-outline">   <symbol id="ai:mdi:clock-time-four-outline" viewBox="0 0 24 24"><path fill="currentColor" d="M12 20c4.4 0 8-3.6 8-8s-3.6-8-8-8s-8 3.6-8 8s3.6 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10S2 17.5 2 12S6.5 2 12 2m5 11.9l-.7 1.3l-5.3-2.9V7h1.5v4.4z"/></symbol><use href="#ai:mdi:clock-time-four-outline"></use>  </svg> 13 min read </span> </div>  <img src="/_astro/cover.C-MqClOx_Z14HJKe.webp" alt="The Tri-Z Architecture: a Pattern for Layering ZIO Applications in Scala" loading="lazy" decoding="async" fetchpriority="auto" width="853" height="480" class="rounded-lg mb-8">  </div> <div class="prose prose-neutral prose-lg md:prose-xl dark:prose-invert prose-img:rounded-xl prose-figure:text-center prose-img:mx-auto">  <p>After working on several different services and spending a lot of time improving the code to make it easier to use, I discovered a pattern for layering my applications that I found very useful.</p>
<p>First, a disclaimer: this architecture is not a one-size-fits-all solution. Different applications have completely different needs, which might make some layers unnecessary. Take it with a grain of salt and adapt it as you see fit!</p>
<h3 id="introduction"><strong>Introduction</strong></h3>
<p>My main job is writing game servers, and these typically have the following characteristics:</p>
<ul>
<li>
<p>Heavy business logic: game rules are complex, and each player action requires validations (to prevent illegal actions) as well as calculations (to determine the outcome).</p>
</li>
<li>
<p>High concurrency: in multi-player games, different players may perform actions at the same time, and those actions may impact each other.</p>
</li>
<li>
<p>High performance: we need to support a large number of players and respond to player actions with the smallest latency possible. This also means that we try to keep the state loaded in memory rather than reading/writing it for each request.</p>
</li>
</ul>
<p>To handle these with ease, I organized my code into these three layers:</p>
<ul>
<li>
<p>The inner core only contains pure business logic (using the <code>ZPure</code> data type).</p>
</li>
<li>
<p>The middle layer consists of atomic state operations (using the <code>ZSTM</code> data type).</p>
</li>
<li>
<p>The outer layer is where we run side effects (using the <code>ZIO</code> data type).</p>
</li>
</ul>
<figure class="rehype-figure-title"><img  loading="lazy" decoding="async" fetchpriority="auto" width="401" height="444" src="/_astro/image-1.ekKMkzTK_1eYrsN.webp" ></figure>
<p>Let’s look into each of these layers in detail.</p>
<h3 id="pure-business-logic-with-zpure">Pure business logic with ZPure</h3>
<p><em>This is a topic I’ve talked about before, so I invite you to check</em> <a href="https://www.youtube.com/watch?v=TVYhFpqlgZ4"><em>my presentation at Scala Matsuri 2022</em></a> <em>(</em><a href="https://github.com/ghostdogpr/slides/blob/92566cb91bfdd2087b50494f2a43de6edf19c2a0/Beautiful%20Domain%20Logic.pdf"><em>slides</em></a><em>) if you haven’t seen it.</em></p>
<p>Keeping your core business logic pure (deterministic and free of side effects) gives you a few important benefits:</p>
<ul>
<li>
<p>You can test individual functions easily because they don’t require a lot of setup such as a database or even mocks for other services. You just need to provide an input and check the resulting output.</p>
</li>
<li>
<p>If you need to fail in the middle of your business logic, using pure code will ensure that there is absolutely no impact from the code that was executed before the failure happened.</p>
</li>
<li>
<p>Pure application logic can be executed multiple times, which means it can be replayed (useful for event sourcing) and retried (useful for <code>ZSTM</code> as we will see later).</p>
</li>
</ul>
<p><code>ZPure</code> is a data type provided by the <a href="https://github.com/zio/zio-prelude">zio-prelude</a> library, a sort of <code>Either</code> on steroids. In addition to returning an error or a result like <code>Either[+E, +A]</code>, a <code>ZPure[+W, -S1, +S2, -R, +E, +A]</code> lets you do several things:</p>
<ul>
<li>
<p>Access a read-only “environment” of type <code>R</code> (for <em>Reader</em>). Typically, this is used to store configuration values that you provide only once when you run the program.</p>
</li>
<li>
<p>Access an input state <code>S1</code>, modify it, and potentially change its type into an output state <code>S2</code>. I have not found a use case where I needed different types for <code>S1</code> and <code>S2</code>, so those two are usually the same type for me.</p>
</li>
<li>
<p>Accumulate a log of values of type <code>W</code> (for <em>Writer</em>). This is very flexible and allows for some creative usage. I’ve used it for storing events in an event sourcing application, for feeding a stream of messages to players in a game, but also for storing actual logs (that are printed in the outermost layer, since it is a side effect). There is an operator named <code>clearLogOnError</code> to determine whether the log is reset or kept when the program fails.</p>
</li>
</ul>
<p>To run a <code>ZPure</code>, you need to provide values for <code>R</code> and <code>S1</code>, and in response, you get a <code>Chunk[W]</code>, and either an error <code>E</code> or an updated state <code>S2</code> with a result <code>A</code>. It is logically equivalent to <code>(R, S1) => (Chunk[W], Either[E, (S2, A)])</code>, but stack-safe and with a ton of useful operators.</p>
<p>If you are familiar with <code>ZIO</code>, <code>ZPure</code> will feel very natural, with the main differences being that you can’t run arbitrary side effects (no <code>attempt</code>) or spawn fibers (no <code>fork</code>).</p>
<p>Type inference is sometimes a bit painful when working with <code>ZPure</code>: for example, when you use <code>ZPure.succeed</code>, you often need to specify explicitly what the state type <code>S</code> is because it cannot be inferred by the value itself. For this reason, I defined a custom trait that exposes functions that are more convenient to use, and I extend it in all of my projects.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="scala"><code><span class="line"><span style="color:#F97583">import</span><span style="color:#B392F0"> zio</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Tag</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#B392F0"> zio</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">prelude</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">*</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#B392F0"> zio</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">prelude</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">fx</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">ZPure</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">trait</span><span style="color:#B392F0"> ZPureConstructors</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">W</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">S</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">R</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Tag</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">E</span><span style="color:#E1E4E8">] {</span></span>
<span class="line"><span style="color:#F97583">  type</span><span style="color:#B392F0"> Program</span><span style="color:#E1E4E8">[</span><span style="color:#F97583">+</span><span style="color:#B392F0">A</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">=</span><span style="color:#B392F0"> ZPure</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">W</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">S</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">S</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">R</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">E</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">A</span><span style="color:#E1E4E8">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  val</span><span style="color:#FFAB70"> unit</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Program</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">Unit</span><span style="color:#E1E4E8">]          </span><span style="color:#F97583">=</span><span style="color:#B392F0"> ZPure</span><span style="color:#E1E4E8">.unit</span></span>
<span class="line"><span style="color:#F97583">  def</span><span style="color:#B392F0"> pure</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">A</span><span style="color:#E1E4E8">](</span><span style="color:#FFAB70">a</span><span style="color:#E1E4E8">: </span><span style="color:#B392F0">A</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Program</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">A</span><span style="color:#E1E4E8">]    </span><span style="color:#F97583">=</span><span style="color:#B392F0"> ZPure</span><span style="color:#E1E4E8">.succeed(a)</span></span>
<span class="line"><span style="color:#F97583">  def</span><span style="color:#B392F0"> fail</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">e</span><span style="color:#E1E4E8">: </span><span style="color:#B392F0">E</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Program</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">Nothing</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">=</span><span style="color:#B392F0"> ZPure</span><span style="color:#E1E4E8">.fail(e)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  def</span><span style="color:#B392F0"> inquire</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">A</span><span style="color:#E1E4E8">](</span><span style="color:#FFAB70">f</span><span style="color:#E1E4E8">: </span><span style="color:#B392F0">R</span><span style="color:#F97583"> =></span><span style="color:#B392F0"> A</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Program</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">A</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">=</span><span style="color:#B392F0"> ZPure</span><span style="color:#E1E4E8">.serviceWith[</span><span style="color:#B392F0">R</span><span style="color:#E1E4E8">](f)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  val</span><span style="color:#FFAB70"> get</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Program</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">S</span><span style="color:#E1E4E8">]                       </span><span style="color:#F97583">=</span><span style="color:#B392F0"> ZPure</span><span style="color:#E1E4E8">.get</span></span>
<span class="line"><span style="color:#F97583">  def</span><span style="color:#B392F0"> set</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">s</span><span style="color:#E1E4E8">: </span><span style="color:#B392F0">S</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Program</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">Unit</span><span style="color:#E1E4E8">]              </span><span style="color:#F97583">=</span><span style="color:#B392F0"> ZPure</span><span style="color:#E1E4E8">.set(s)</span></span>
<span class="line"><span style="color:#F97583">  def</span><span style="color:#B392F0"> inspect</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">A</span><span style="color:#E1E4E8">](</span><span style="color:#FFAB70">f</span><span style="color:#E1E4E8">: </span><span style="color:#B392F0">S</span><span style="color:#F97583"> =></span><span style="color:#B392F0"> A</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Program</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">A</span><span style="color:#E1E4E8">]     </span><span style="color:#F97583">=</span><span style="color:#B392F0"> ZPure</span><span style="color:#E1E4E8">.modify(s </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> (f(s), s))</span></span>
<span class="line"><span style="color:#F97583">  def</span><span style="color:#B392F0"> update</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">A</span><span style="color:#E1E4E8">](</span><span style="color:#FFAB70">f</span><span style="color:#E1E4E8">: </span><span style="color:#B392F0">S</span><span style="color:#F97583"> =></span><span style="color:#B392F0"> S</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Program</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">Unit</span><span style="color:#E1E4E8">]   </span><span style="color:#F97583">=</span><span style="color:#B392F0"> ZPure</span><span style="color:#E1E4E8">.update(f)</span></span>
<span class="line"><span style="color:#F97583">  def</span><span style="color:#B392F0"> modify</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">A</span><span style="color:#E1E4E8">](</span><span style="color:#FFAB70">f</span><span style="color:#E1E4E8">: </span><span style="color:#B392F0">S</span><span style="color:#F97583"> =></span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">A</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">S</span><span style="color:#E1E4E8">))</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Program</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">A</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">=</span><span style="color:#B392F0"> ZPure</span><span style="color:#E1E4E8">.modify(f)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  def</span><span style="color:#B392F0"> log</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">w</span><span style="color:#E1E4E8">: </span><span style="color:#B392F0">W</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Program</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">Unit</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">=</span><span style="color:#B392F0"> ZPure</span><span style="color:#E1E4E8">.log(w)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  def</span><span style="color:#B392F0"> when</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">condition</span><span style="color:#E1E4E8">: </span><span style="color:#B392F0">Boolean</span><span style="color:#E1E4E8">)(</span><span style="color:#FFAB70">program</span><span style="color:#E1E4E8">: </span><span style="color:#B392F0">Program</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">Unit</span><span style="color:#E1E4E8">])</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Program</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">Unit</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">=</span></span>
<span class="line"><span style="color:#B392F0">    ZPure</span><span style="color:#E1E4E8">.when(condition)(program).unit</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"> // we have a few more helpers</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>Using this little DSL makes things simpler as you don’t need to specify any type parameters since you don’t use <code>ZPure</code> constructors directly, and you can have all your functions return a concise <code>Program[A]</code> thanks to the type alias.</p>
<p>Here’s a little example of business logic using this DSL:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="scala"><code><span class="line"><span style="color:#F97583">  def</span><span style="color:#B392F0"> join</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">userId</span><span style="color:#E1E4E8">: </span><span style="color:#B392F0">UserId</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Program</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">Unit</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">=</span></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">      max  </span><span style="color:#F97583">&#x3C;-</span><span style="color:#E1E4E8"> inquire(_.maxPlayers)</span></span>
<span class="line"><span style="color:#E1E4E8">      size </span><span style="color:#F97583">&#x3C;-</span><span style="color:#E1E4E8"> inspect(_.players.length)</span></span>
<span class="line"><span style="color:#E1E4E8">      _    </span><span style="color:#F97583">&#x3C;-</span><span style="color:#E1E4E8"> when(currentPlayers </span><span style="color:#F97583">>=</span><span style="color:#E1E4E8"> maxPlayers)(fail(</span><span style="color:#B392F0">Error</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">FullGame</span><span style="color:#E1E4E8">))</span></span>
<span class="line"><span style="color:#E1E4E8">      _    </span><span style="color:#F97583">&#x3C;-</span><span style="color:#E1E4E8"> update(_.playerJoined(userId))</span></span>
<span class="line"><span style="color:#E1E4E8">      _    </span><span style="color:#F97583">&#x3C;-</span><span style="color:#E1E4E8"> log(</span><span style="color:#B392F0">PlayerJoined</span><span style="color:#E1E4E8">(userId))</span></span>
<span class="line"><span style="color:#E1E4E8">    } </span><span style="color:#F97583">yield</span><span style="color:#E1E4E8"> ()</span></span></code></pre>
<p>In that example, we first access the environment to get the maximum number of players allowed by the configuration, then we check the current state and fail if the game is already full. If not, we proceed to update the state and publish an event that will be sent to all users.</p>
<p>Code like this is ideal for writing business logic: it is pretty self-explanatory, doesn’t need to care about concurrency, and can be easily tested by running the program with different values for the state and the environment. The important idea is that this part of the code should be entirely focused on the business domain and free of all technical considerations.</p>
<p>An important note to conclude: as my friend <a href="https://x.com/guizmaii">Jules Ivanic</a> often likes to say (see <a href="https://www.youtube.com/watch?v=nZAxtQAJaU0">The Cost of your ZIO Addiction</a>), don’t use an effect when you don’t need one! Use <code>ZPure</code> only when you actually need the state, the log, or the environment. If a function can only return a value or nothing, use <code>Option</code>. If a function returns a value or fails with an error, use <code>Either</code>. It will be even easier to test, and you can use <code>ZPure.fromOption</code> or <code>ZPure.fromEither</code> to integrate them into the rest of your code.</p>
<h3 id="atomic-state-operations-with-zstm">Atomic State Operations with ZSTM</h3>
<p>One characteristic of <code>ZPure</code> is that there is no concept of fiber or parallelism. Running a single <code>ZPure</code> will only consider the provided state and there is no way that state can be modified by an external source. That means we need to deal with how concurrent requests affect the state at the calling site. Let’s look at an example.</p>
<p>Let’s say we develop a game. As Scala FP developers using ZIO, we typically store the game state in a <code>Ref</code>.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="scala"><code><span class="line"><span style="color:#F97583">case</span><span style="color:#F97583"> class</span><span style="color:#B392F0"> GameState</span><span style="color:#E1E4E8">(...)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">class</span><span style="color:#B392F0"> GameLogic</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">state</span><span style="color:#E1E4E8">: </span><span style="color:#B392F0">Ref</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">GameState</span><span style="color:#E1E4E8">]) { ... }</span></span></code></pre>
<p>When a user sends a request, we can use one of the <code>Ref</code> atomic operations such as <code>update</code> or <code>modify</code> to change the value of the state.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="scala"><code><span class="line"><span style="color:#F97583">def</span><span style="color:#B392F0"> handleRequest</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">request</span><span style="color:#E1E4E8">: </span><span style="color:#B392F0">PlayerRequest</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> UIO</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">Unit</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">=</span></span>
<span class="line"><span style="color:#E1E4E8">  state.modify { oldState </span><span style="color:#F97583">=></span></span>
<span class="line"><span style="color:#6A737D">    // we run our ZPure program</span></span>
<span class="line"><span style="color:#E1E4E8">    program(request).runAll(oldState) </span><span style="color:#F97583">match</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">      // success, update the state</span></span>
<span class="line"><span style="color:#F97583">      case</span><span style="color:#E1E4E8"> (_, </span><span style="color:#B392F0">Right</span><span style="color:#E1E4E8">((newState, _))) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">Right</span><span style="color:#E1E4E8">(()), newState)</span></span>
<span class="line"><span style="color:#6A737D">      // error, keep the old state</span></span>
<span class="line"><span style="color:#F97583">      case</span><span style="color:#E1E4E8"> (_, </span><span style="color:#B392F0">Left</span><span style="color:#E1E4E8">(cause))          </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">Left</span><span style="color:#E1E4E8">(cause.first), oldState)</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">  }.flatMap(</span><span style="color:#B392F0">ZIO</span><span style="color:#E1E4E8">.fromEither)</span></span></code></pre>
<p>This function will run our <code>ZPure</code> program, which returns either a failure or a result (ignored for the sake of the example) and a new state. In the latter case, we replace the state in the <code>Ref</code> with this new value. <code>Ref</code> is designed so that if there are two concurrent requests happening at the same time, only one of them is allowed to modify the state. It uses <code>AtomicReference</code> under the hood, with a while loop that keeps retrying if the state has been changed between trials. Thankfully, we are using <code>ZPure</code>, so retrying will have no impact on the system apart from performance.</p>
<p>What if our program takes a little bit longer to run and we have a lot of requests? We might have contention issues with multiple fibers running the same code again and again, and only one of them succeeding each time. It feels inefficient to retry our whole business logic every time.</p>
<p>One solution is to switch from <code>Ref</code> to <code>Ref.Synchronized</code>. Unlike <code>Ref</code>, <code>Ref.Synchronized</code> is not optimistic and adds a <code>Semaphore</code> of size one to prevent concurrent execution of code accessing the same reference. Another option is to use a <code>Queue</code> with a single fiber processing requests. A queue is particularly well-suited for asynchronous workloads (e.g., gRPC streams), but can also be used for request-response workloads (with <code>Promise</code>).</p>
<p>Let’s say only a given list of players is allowed to join that game, and once a player leaves, they are not able to join again. This raises the question of where to store this data.</p>
<p>One approach is to put everything into <code>GameState</code>.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="scala"><code><span class="line"><span style="color:#F97583">case</span><span style="color:#F97583"> class</span><span style="color:#B392F0"> GameState</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#E1E4E8">  ...</span></span>
<span class="line"><span style="color:#FFAB70">  allowedPlayers</span><span style="color:#E1E4E8">: </span><span style="color:#B392F0">Set</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">UserId</span><span style="color:#E1E4E8">],</span></span>
<span class="line"><span style="color:#FFAB70">  leftPlayers</span><span style="color:#E1E4E8">: </span><span style="color:#B392F0">Set</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">UserId</span><span style="color:#E1E4E8">]</span></span>
<span class="line"><span style="color:#E1E4E8">)</span></span></code></pre>
<p>One problem with putting everything in the same object is that it tends to become too large, and modifying it will involve many <code>copy</code> operations (for example, we need to do <code>state.copy(leftPlayers = state.leftPlayers + userId)</code> to add a user to <code>leftPlayers</code>), which is not the best UX. You can write helper functions to hide the <code>copy</code>, but it’s more boilerplate. Another issue with <code>Ref.Synchronized</code> specifically is that regardless of which part of the state you modify, you still need to wait on the same <code>Semaphore</code>.</p>
<p>The other approach is to split the state into different <code>Ref</code>.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="scala"><code><span class="line"><span style="color:#F97583">class</span><span style="color:#B392F0"> GameLogic</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#FFAB70">  state</span><span style="color:#E1E4E8">: </span><span style="color:#B392F0">Ref</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">GameState</span><span style="color:#E1E4E8">],</span></span>
<span class="line"><span style="color:#FFAB70">  allowedPlayers</span><span style="color:#E1E4E8">: </span><span style="color:#B392F0">Ref</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">Set</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">UserId</span><span style="color:#E1E4E8">]],</span></span>
<span class="line"><span style="color:#FFAB70">  leftPlayers</span><span style="color:#E1E4E8">: </span><span style="color:#B392F0">Ref</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">Set</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">UserId</span><span style="color:#E1E4E8">]]</span></span>
<span class="line"><span style="color:#E1E4E8">)</span></span></code></pre>
<p>The problem here is that while each <code>Ref</code> offers atomic operations, there is no atomic operation between multiple <code>Ref</code>.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="scala"><code><span class="line"><span style="color:#F97583">def</span><span style="color:#B392F0"> join</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">userId</span><span style="color:#E1E4E8">: </span><span style="color:#B392F0">UserId</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Task</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">Unit</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">=</span></span>
<span class="line"><span style="color:#F97583">  for</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">    isAllowed   </span><span style="color:#F97583">&#x3C;-</span><span style="color:#E1E4E8"> allowedPlayers.get.map(_.contains(userId))</span></span>
<span class="line"><span style="color:#E1E4E8">    alreadyLeft </span><span style="color:#F97583">&#x3C;-</span><span style="color:#E1E4E8"> leftPlayers.get.map(_.contains(userId))</span></span>
<span class="line"><span style="color:#E1E4E8">    _           </span><span style="color:#F97583">&#x3C;-</span><span style="color:#B392F0"> ZIO</span><span style="color:#E1E4E8">.when(isAllowed </span><span style="color:#F97583">&#x26;&#x26;</span><span style="color:#F97583"> !</span><span style="color:#E1E4E8">alreadyLeft)(join(userId))</span></span>
<span class="line"><span style="color:#E1E4E8">  } </span><span style="color:#F97583">yield</span><span style="color:#E1E4E8"> ()</span></span></code></pre>
<p>Do you see the problem with the code above? <code>alreadyLeft</code> might be <code>false</code>, but before the <code>join</code> line is executed, another fiber might have added the user to <code>leftPlayers</code>. Yet, we’re going to proceed with <code>join</code> anyway!</p>
<p>We could introduce a <code>Semaphore</code> around that code, but that adds even more contention than there was already, and it feels too low-level in our code. Fortunately, there is a better option included in the ZIO library: <code>ZSTM</code>.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="scala"><code><span class="line"><span style="color:#F97583">class</span><span style="color:#B392F0"> GameLogic</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#FFAB70">  state</span><span style="color:#E1E4E8">: </span><span style="color:#B392F0">TRef</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">GameState</span><span style="color:#E1E4E8">],</span></span>
<span class="line"><span style="color:#FFAB70">  allowedPlayers</span><span style="color:#E1E4E8">: </span><span style="color:#B392F0">TSet</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">UserId</span><span style="color:#E1E4E8">],</span></span>
<span class="line"><span style="color:#FFAB70">  leftPlayers</span><span style="color:#E1E4E8">: </span><span style="color:#B392F0">TSet</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">UserId</span><span style="color:#E1E4E8">]</span></span>
<span class="line"><span style="color:#E1E4E8">)</span></span></code></pre>
<p><code>TRef</code> has exactly the same operators as <code>Ref</code>, with the only difference being that they return <code>ZSTM</code> instead of <code>ZIO</code>. What does this change? <code>ZSTM</code> computations can be combined together and committed all at once in a single transaction. If two transactions happen at the same time and conflict with each other, one will succeed and the other will be retried, which is why you can’t run side effects in <code>ZSTM</code>. Similarly, if a transaction fails, nothing will be committed and the data will remain unchanged.</p>
<p>Even better: structures like <code>TSet</code>, <code>TMap</code>, or <code>TArray</code> are specialized versions of <code>TRef</code> that offer convenient operators that also return <code>ZSTM</code> but will cause transactions to conflict <strong>only if they are accessing the same elements</strong>. This means that if a <code>ZSTM</code> is adding a particular key while another one is modifying another key in the same data structure, both transactions can be committed without retry, which reduces contention issues significantly.</p>
<p>To illustrate this, let’s revisit our previous example.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="scala"><code><span class="line"><span style="color:#F97583">def</span><span style="color:#B392F0"> join</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">userId</span><span style="color:#E1E4E8">: </span><span style="color:#B392F0">UserId</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Task</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">Unit</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">=</span></span>
<span class="line"><span style="color:#B392F0">  ZSTM</span><span style="color:#E1E4E8">.atomically {</span></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">      isAllowed   </span><span style="color:#F97583">&#x3C;-</span><span style="color:#E1E4E8"> allowedPlayers.contains(userId)</span></span>
<span class="line"><span style="color:#E1E4E8">      alreadyLeft </span><span style="color:#F97583">&#x3C;-</span><span style="color:#E1E4E8"> leftPlayers.contains(userId)</span></span>
<span class="line"><span style="color:#E1E4E8">      _           </span><span style="color:#F97583">&#x3C;-</span><span style="color:#B392F0"> ZSTM</span><span style="color:#E1E4E8">.when(isAllowed </span><span style="color:#F97583">&#x26;&#x26;</span><span style="color:#F97583"> !</span><span style="color:#E1E4E8">alreadyLeft)(join(userId))</span></span>
<span class="line"><span style="color:#E1E4E8">    } </span><span style="color:#F97583">yield</span><span style="color:#E1E4E8"> ()</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span></code></pre>
<p>First, our code became simpler because <code>TSet</code> has a <code>contains</code> method. Then, we notice the code is wrapped inside <code>ZSTM.atomically</code>, which can also be expressed by calling <code>commit</code> on the same block and turns our <code>ZSTM</code> into a <code>ZIO</code> by running the transaction. This ensures that if the same <code>userId</code> in <code>allowedPlayers</code> or <code>leftPlayers</code> is modified by another fiber, the transaction will be retried. It is therefore impossible to have the earlier problem where <code>join</code> is called while the player is in <code>leftPlayers</code>.</p>
<p>In summary, <code>ZSTM</code> allows us to simplify our code by avoiding the usage of <code>copy</code> on a large state stored in a single <code>Ref</code>, but also makes concurrency simpler to deal with by giving us transactions across multiple objects. Because <code>ZSTM</code> effects cannot have side effects (due to the fact they can be retried), they are an ideal fit for wrapping <code>ZPure</code> computations.</p>
<p>A final note on performance: while benchmarking one of my projects, I found that the current implementation of <code>ZSTM</code> was not as fast as expected and opened <a href="https://github.com/zio/zio/issues/8983">this issue</a>. Thankfully, a large bounty was recently allocated to it and <a href="https://github.com/zio/zio/issues/8983#issuecomment-2258067753">a maintainer is working on it</a> so we can expect improvements soon! Regardless of this benchmark, I kept using it in my code because it didn’t affect the overall performance in a significant way.</p>
<h3 id="side-effects-with-zio">Side effects with ZIO</h3>
<p>Running a <code>ZSTM</code> transaction returns a <code>ZIO</code>: we’re now in the outermost layer! Here, we’re allowed to run side effects. Ideally, the business logic in this part of the code should be reduced to a minimum, and we should be doing side effects only.</p>
<p>Examples of these side effects are:</p>
<ul>
<li>
<p>We might need to call some external services or APIs to get some data needed to call the business logic. Or we might need to do something after that logic is executed, for example, persisting the new state to a database.</p>
</li>
<li>
<p>We might take advantage of the log from <code>ZPure</code> to forward responses to clients using a <code>Hub</code> or publish events to a <code>Queue</code> that will trigger additional processing.</p>
</li>
</ul>
<p>You might have recognized the distinction between orchestration and choreography. In practice, both flows are useful and can be combined depending on the use case.</p>
<p>There is not a lot to say about this layer, as I imagine most readers are familiar with ZIO. The most important point about side effects here is where we decide <em>not</em> to run them. By pushing them outside of the business logic, we can separate concerns and reason about our code without conflating unrelated things:</p>
<ul>
<li>
<p>The ZPure layer is where we focus 100% on our business logic.</p>
</li>
<li>
<p>The ZSTM layer is where we manage our state and its boundaries.</p>
</li>
<li>
<p>The ZIO layer is where we put everything together.</p>
</li>
</ul>
<figure class="rehype-figure-title"><img  loading="lazy" decoding="async" fetchpriority="auto" width="680" height="411" src="/_astro/image-2.C6PjMTdS_1LVBkX.webp" ></figure>
<p>One question you might have in the context of a game server is how to scale to multiple servers when the state is stored in memory like this. Indeed, by definition, <code>ZSTM</code> transactions are in-memory transactions and cannot run across multiple servers. The answer is simple: players are usually grouped into smaller entities, and each entity (e.g., a single game instance or a room) runs in a single place on the cluster. To manage this, we either use distributed actors with location transparency (with <a href="https://github.com/devsisters/shardcake">Shardcake</a>) or dedicated servers spawned on-demand (with <a href="https://agones.dev/site/">Agones</a>).</p>
<h3 id="conclusion">Conclusion</h3>
<p>Since I “discovered” this pattern, I have started to apply it to different projects and found that it fits remarkably well with the kind of concurrent and stateful workloads I am working with, which are very typical in the game industry. I am planning to refactor a few existing projects to use this pattern, which means essentially splitting existing code into parts with clearer boundaries and concerns. This approach has significantly improved code maintainability and performance.</p>
<p>Is anyone out there doing something similar? I’d be curious to hear about similar code architecture patterns and practices.</p>  </div> </div> </div> </article> </main>  <footer> <div class="app-container grid md:grid-cols-3 gap-12 py-16 border-t-2 border-foreground/50 dark:border-foreground-dark/50"> <div> <a href="/" class="block w-fit" aria-label="Home"> <svg width="36" height="36" viewBox="0 0 36 36" fill="none">
  <rect width="36" height="36" rx="8" fill="currentColor" opacity="0.1" />
  <text x="18" y="25" font-family="system-ui, -apple-system, sans-serif" font-size="18" font-weight="700" fill="currentColor" text-anchor="middle">PR</text>
</svg> </a> </div> <div> <h3 class="font-semibold text-2xl">Links</h3> <div class="flex flex-wrap gap-4 mt-4"> <a class="text-lg" href target="_blank" rel="noopener noreferrer"> Blog </a><a class="text-lg" href="https://github.com/sponsors/ghostdogpr" target="_blank" rel="noopener noreferrer"> Sponsor </a> <a href="rss.xml" target="_blank" rel="noopener noreferrer" class="text-lg" aria-label="RSS Feed"> <svg width="1em" height="1em" class="w-6 h-6" data-icon="mdi:rss">   <symbol id="ai:mdi:rss" viewBox="0 0 24 24"><path fill="currentColor" d="M6.18 15.64a2.18 2.18 0 0 1 2.18 2.18C8.36 19 7.38 20 6.18 20C5 20 4 19 4 17.82a2.18 2.18 0 0 1 2.18-2.18M4 4.44A15.56 15.56 0 0 1 19.56 20h-2.83A12.73 12.73 0 0 0 4 7.27zm0 5.66a9.9 9.9 0 0 1 9.9 9.9h-2.83A7.07 7.07 0 0 0 4 12.93z"/></symbol><use href="#ai:mdi:rss"></use>  </svg> </a> </div> </div> <div> <h3 class="font-semibold text-2xl">Socials</h3> <div class="flex flex-wrap gap-4 mt-4"> <a class="text-lg" href="https://github.com/ghostdogpr" target="_blank" rel="noopener noreferrer"> GitHub </a><a class="text-lg" href="https://www.linkedin.com/in/pierrericadat/" target="_blank" rel="noopener noreferrer"> LinkedIn </a><a class="text-lg" href="https://twitter.com/ghostdogpr" target="_blank" rel="noopener noreferrer"> X / Twitter </a> </div> </div> </div> <div class="app-container flex justify-between items-center pb-6 text-center"> <p class="text-left md:text-center w-full">
Theme: <a class="underline" href="https://github.com/yashjawale/saral-theme-astro" target="_blank">Saral</a> </p> </div> </footer> </body></html>
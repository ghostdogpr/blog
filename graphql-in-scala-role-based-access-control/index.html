<!DOCTYPE html><html lang="en"> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="generator" content="Astro v5.13.7"><!-- Favicons --><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="apple-mobile-web-app-title" content="Pierre Ricadat's Tech Blog"><!-- Canonical URL --><link rel="canonical" href="https://blog.pierre-ricadat.com/graphql-in-scala-role-based-access-control/"><!-- Primary Meta Tags --><title>GraphQL in Scala: Role-Based Access Control</title><meta name="title" content="GraphQL in Scala: Role-Based Access Control"><meta name="description" content="Today, I'm going to answer a question asked by Łukasz Biały on Twitter:
"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://blog.pierre-ricadat.com/graphql-in-scala-role-based-access-control/"><meta property="og:title" content="GraphQL in Scala: Role-Based Access Control"><meta property="og:description" content="Today, I'm going to answer a question asked by Łukasz Biały on Twitter:
"><meta property="og:image" content="https://blog.pierre-ricadat.com/saral-og.jpg"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://blog.pierre-ricadat.com/graphql-in-scala-role-based-access-control/"><meta property="twitter:title" content="GraphQL in Scala: Role-Based Access Control"><meta property="twitter:description" content="Today, I'm going to answer a question asked by Łukasz Biały on Twitter:
"><meta property="twitter:image" content="https://blog.pierre-ricadat.com/saral-og.jpg"><!-- RSS Auto-discovery --><link rel="alternate" type="application/rss+xml" title="Pierre Ricadat's Tech Blog RSS Feed" href="https://blog.pierre-ricadat.com/rss.xml"><link rel="stylesheet" href="/_astro/_slug_.DSRIcTml.css"><script>!(function(w,p,f,c){if(!window.crossOriginIsolated && !navigator.serviceWorker) return;c=w[p]=Object.assign(w[p]||{},{"lib":"/~partytown/","debug":false});c[f]=(c[f]||[]).concat(["dataLayer.push"])})(window,'partytown','forward');/* Partytown 0.11.2 - MIT QwikDev */
const t={preserveBehavior:!1},e=e=>{if("string"==typeof e)return[e,t];const[n,r=t]=e;return[n,{...t,...r}]},n=Object.freeze((t=>{const e=new Set;let n=[];do{Object.getOwnPropertyNames(n).forEach((t=>{"function"==typeof n[t]&&e.add(t)}))}while((n=Object.getPrototypeOf(n))!==Object.prototype);return Array.from(e)})());!function(t,r,o,i,a,s,c,l,d,p,u=t,f){function h(){f||(f=1,"/"==(c=(s.lib||"/~partytown/")+(s.debug?"debug/":""))[0]&&(d=r.querySelectorAll('script[type="text/partytown"]'),i!=t?i.dispatchEvent(new CustomEvent("pt1",{detail:t})):(l=setTimeout(v,(null==s?void 0:s.fallbackTimeout)||1e4),r.addEventListener("pt0",w),a?y(1):o.serviceWorker?o.serviceWorker.register(c+(s.swPath||"partytown-sw.js"),{scope:c}).then((function(t){t.active?y():t.installing&&t.installing.addEventListener("statechange",(function(t){"activated"==t.target.state&&y()}))}),console.error):v())))}function y(e){p=r.createElement(e?"script":"iframe"),t._pttab=Date.now(),e||(p.style.display="block",p.style.width="0",p.style.height="0",p.style.border="0",p.style.visibility="hidden",p.setAttribute("aria-hidden",!0)),p.src=c+"partytown-"+(e?"atomics.js?v=0.11.2":"sandbox-sw.html?"+t._pttab),r.querySelector(s.sandboxParent||"body").appendChild(p)}function v(n,o){for(w(),i==t&&(s.forward||[]).map((function(n){const[r]=e(n);delete t[r.split(".")[0]]})),n=0;n<d.length;n++)(o=r.createElement("script")).innerHTML=d[n].innerHTML,o.nonce=s.nonce,r.head.appendChild(o);p&&p.parentNode.removeChild(p)}function w(){clearTimeout(l)}s=t.partytown||{},i==t&&(s.forward||[]).map((function(r){const[o,{preserveBehavior:i}]=e(r);u=t,o.split(".").map((function(e,r,o){var a;u=u[o[r]]=r+1<o.length?u[o[r]]||(a=o[r+1],n.includes(a)?[]:{}):(()=>{let e=null;if(i){const{methodOrProperty:n,thisObject:r}=((t,e)=>{let n=t;for(let t=0;t<e.length-1;t+=1)n=n[e[t]];return{thisObject:n,methodOrProperty:e.length>0?n[e[e.length-1]]:void 0}})(t,o);"function"==typeof n&&(e=(...t)=>n.apply(r,...t))}return function(){let n;return e&&(n=e(arguments)),(t._ptf=t._ptf||[]).push(o,arguments),n}})()}))})),"complete"==r.readyState?h():(t.addEventListener("DOMContentLoaded",h),t.addEventListener("load",h))}(window,document,navigator,top,window.crossOriginIsolated);;(e=>{e.addEventListener("astro:before-swap",e=>{let r=document.body.querySelector("iframe[src*='/~partytown/']");if(r)e.newDocument.body.append(r)})})(document);</script></head> <body class="text-foreground bg-background font-light dark:text-foreground-dark dark:bg-background-dark transition-colors"> <header class="fixed top-0 w-full z-40 bg-background dark:bg-background-dark"> <nav class=""> <div class="app-container flex justify-between items-center py-5"> <a href="/" aria-label="Home"> <svg width="36" height="36" viewBox="0 0 36 36" fill="none">
  <rect width="36" height="36" rx="8" fill="currentColor" opacity="0.1" />
  <text x="18" y="25" font-family="system-ui, -apple-system, sans-serif" font-size="18" font-weight="700" fill="currentColor" text-anchor="middle">PR</text>
</svg> </a> <div class="gap-8 hidden md:flex items-center"> <a href="/" class="text-lg" target="_self" data-astro-cid-rieiwi5x> Blog </a> <a href="https://github.com/sponsors/ghostdogpr" class="text-lg" target="_blank" data-astro-cid-rieiwi5x> Sponsor </a>  <div class="border-[1px] border-foreground dark:border-foreground-dark rounded-full flex justify-center items-center text-foreground dark:text-foreground-dark [&#38;>*:hover]:brightness-75 md:opacity-80 [&#38;>*]:cursor-pointer" data-astro-cid-lgn464si> <button data-theme="theme-auto" aria-label="Auto Theme" title="Set theme to follow system preference" class="theme-button theme-auto" data-astro-cid-lgn464si> <svg width="1em" height="1em" aria-hidden="true" data-astro-cid-lgn464si="true" class="duration-0 text-2xl md:text-xl" data-icon="mdi:brightness-auto">   <symbol id="ai:mdi:brightness-auto" viewBox="0 0 24 24"><path fill="currentColor" d="m14.3 16l-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69L8.69 4H4v4.69L.69 12L4 15.31V20h4.69L12 23.31L15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"/></symbol><use href="#ai:mdi:brightness-auto"></use>  </svg> </button> <button data-theme="theme-light" aria-label="Light Theme" title="Set theme to light" class="theme-button theme-light" data-astro-cid-lgn464si> <svg width="1em" height="1em" aria-hidden="true" data-astro-cid-lgn464si="true" class="duration-0 text-2xl md:text-xl" data-icon="mdi:white-balance-sunny">   <symbol id="ai:mdi:white-balance-sunny" viewBox="0 0 24 24"><path fill="currentColor" d="m3.55 19.09l1.41 1.41l1.8-1.79l-1.42-1.42M12 6c-3.31 0-6 2.69-6 6s2.69 6 6 6s6-2.69 6-6c0-3.32-2.69-6-6-6m8 7h3v-2h-3m-2.76 7.71l1.8 1.79l1.41-1.41l-1.79-1.8M20.45 5l-1.41-1.4l-1.8 1.79l1.42 1.42M13 1h-2v3h2M6.76 5.39L4.96 3.6L3.55 5l1.79 1.81zM1 13h3v-2H1m12 9h-2v3h2"/></symbol><use href="#ai:mdi:white-balance-sunny"></use>  </svg> </button> <button data-theme="theme-dark" aria-label="Dark Theme" title="Set theme to dark" class="theme-button theme-dark" data-astro-cid-lgn464si> <svg width="1em" height="1em" aria-hidden="true" data-astro-cid-lgn464si="true" class="duration-0 text-2xl md:text-xl" data-icon="mdi:moon-and-stars">   <symbol id="ai:mdi:moon-and-stars" viewBox="0 0 24 24"><path fill="currentColor" d="m17.75 4.09l-2.53 1.94l.91 3.06l-2.63-1.81l-2.63 1.81l.91-3.06l-2.53-1.94L12.44 4l1.06-3l1.06 3zm3.5 6.91l-1.64 1.25l.59 1.98l-1.7-1.17l-1.7 1.17l.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85c-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14c.4-.4.82-.76 1.27-1.08c.75-.53 1.93.36 1.85 1.19c-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82c-2.81 3.14-2.7 7.96.31 10.98c3.02 3.01 7.84 3.12 10.98.31"/></symbol><use href="#ai:mdi:moon-and-stars"></use>  </svg> </button> </div>  </div> <button class="md:hidden cursor-pointer" id="nav-open-btn" aria-label="Open navigation menu" title="Open navigation menu"> <svg width="32" height="32" aria-hidden="true" data-icon="mdi:menu">   <symbol id="ai:mdi:menu" viewBox="0 0 24 24"><path fill="currentColor" d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></symbol><use href="#ai:mdi:menu"></use>  </svg> </button> <!-- Mobile nav --> <div class="translate-x-full md:hidden fixed top-0 right-0 bg-background dark:bg-background-dark h-screen w-5/6 px-8 py-6 transition-transform z-40 border-l-[1px] border-background" id="mobile-menu"> <button id="nav-close-btn" class="ml-auto block cursor-pointer" aria-label="Close navigation menu" title="Close navigation menu"> <svg width="32" height="32" aria-hidden="true" data-icon="mdi:close">   <symbol id="ai:mdi:close" viewBox="0 0 24 24"><path fill="currentColor" d="M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12z"/></symbol><use href="#ai:mdi:close"></use>  </svg> </button> <div class="flex flex-col h-full items-start gap-8 pt-16"> <a href="/" class="text-4xl font-light" target="_self" data-astro-cid-rieiwi5x> Blog </a> <a href="https://github.com/sponsors/ghostdogpr" class="text-4xl font-light" target="_blank" data-astro-cid-rieiwi5x> Sponsor </a>  <div class="mt-4 border-[1px] border-foreground dark:border-foreground-dark rounded-full flex justify-center items-center text-foreground dark:text-foreground-dark [&#38;>*:hover]:brightness-75 md:opacity-80 [&#38;>*]:cursor-pointer" data-astro-cid-lgn464si> <button data-theme="theme-auto" aria-label="Auto Theme" title="Set theme to follow system preference" class="theme-button theme-auto" data-astro-cid-lgn464si> <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" data-astro-cid-lgn464si="true" class="duration-0 text-2xl md:text-xl" data-icon="mdi:brightness-auto">   <use href="#ai:mdi:brightness-auto"></use>  </svg> </button> <button data-theme="theme-light" aria-label="Light Theme" title="Set theme to light" class="theme-button theme-light" data-astro-cid-lgn464si> <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" data-astro-cid-lgn464si="true" class="duration-0 text-2xl md:text-xl" data-icon="mdi:white-balance-sunny">   <use href="#ai:mdi:white-balance-sunny"></use>  </svg> </button> <button data-theme="theme-dark" aria-label="Dark Theme" title="Set theme to dark" class="theme-button theme-dark" data-astro-cid-lgn464si> <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" data-astro-cid-lgn464si="true" class="duration-0 text-2xl md:text-xl" data-icon="mdi:moon-and-stars">   <use href="#ai:mdi:moon-and-stars"></use>  </svg> </button> </div>  </div> </div> </div> </nav> <script type="module">function e(){document.querySelector("#mobile-menu")?.classList.toggle("mobile-nav-open")}document.querySelector("#nav-open-btn")?.addEventListener("click",e);document.querySelector("#nav-close-btn")?.addEventListener("click",e);</script> </header> <script>
	function reComputeTheme() {
		if (
			localStorage.theme === 'dark' ||
			(!('theme' in localStorage) &&
				window.matchMedia('(prefers-color-scheme: dark)').matches)
		) {
			document.documentElement.classList.add('dark')
		} else {
			document.documentElement.classList.remove('dark')
		}

		const theme = localStorage.theme || 'auto'
		document
			.querySelectorAll(`[data-theme="theme-${theme}"]`)
			.forEach((el) => el.classList.add('active'))
	}

	function addThemeEventListeners() {
		themeButtons = document.querySelectorAll('.theme-button')
		themeButtons.forEach((button) => {
			button.addEventListener('click', () => {
				themeButtons.forEach((btn) => btn.classList.remove('active'))
				button.classList.add('active')
				if (button.dataset.theme === 'theme-auto') {
					localStorage.removeItem('theme')
					reComputeTheme()
				} else {
					localStorage.theme = button.dataset.theme.replace('theme-', '')
					document.documentElement.classList.toggle(
						'dark',
						button.dataset.theme === 'theme-dark'
					)
				}
			})
		})
	}

	// Set active class on OS theme change
	window
		.matchMedia('(prefers-color-scheme: dark)')
		.addEventListener('change', (_e) => {
			reComputeTheme()
		})

	// run recomputeTheme when screen crosses 768px
	window.matchMedia('(min-width: 768px)').addEventListener('change', (_e) => {
		addThemeEventListeners()
		reComputeTheme()
	})

	reComputeTheme()

	// Run on page load
	window.addEventListener('DOMContentLoaded', () => {
		addThemeEventListeners()
		reComputeTheme()
	})
</script>  <main> <article> <div class="app-container flex flex-col lg:flex-row-reverse justify-between gap-8 py-24 relative"> <div class="md:w-1/4 relative"> <div class="sticky top-0 md:top-28 hidden lg:block"> <div></div> </div> </div> <div class="grow w-full md:max-w-[75ch]"> <div> <h1 class="text-4xl sm:text-5xl leading-snug pt-12 font-bold"> GraphQL in Scala: Role-Based Access Control </h1> <div class="text-lg flex items-center gap-4 flex-wrap py-8"> <!-- Publish date --> <span> <svg width="1em" height="1em" class="inline-block text-primary dark:text-primary-dark" data-icon="mdi:calendar-month-outline">   <symbol id="ai:mdi:calendar-month-outline" viewBox="0 0 24 24"><path fill="currentColor" d="M7 11h2v2H7zm14-6v14c0 1.11-.89 2-2 2H5a2 2 0 0 1-2-2V5c0-1.1.9-2 2-2h1V1h2v2h8V1h2v2h1a2 2 0 0 1 2 2M5 7h14V5H5zm14 12V9H5v10zm-4-6v-2h2v2zm-4 0v-2h2v2zm-4 2h2v2H7zm8 2v-2h2v2zm-4 0v-2h2v2z"/></symbol><use href="#ai:mdi:calendar-month-outline"></use>  </svg> <time datetime="2024-06-03T00:00:00.000Z"> 3 Jun 2024 </time> </span> <!-- Updated date -->  <!-- Read time --> <span> <svg width="1em" height="1em" class="inline-block text-primary dark:text-primary-dark" data-icon="mdi:clock-time-four-outline">   <symbol id="ai:mdi:clock-time-four-outline" viewBox="0 0 24 24"><path fill="currentColor" d="M12 20c4.4 0 8-3.6 8-8s-3.6-8-8-8s-8 3.6-8 8s3.6 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10S2 17.5 2 12S6.5 2 12 2m5 11.9l-.7 1.3l-5.3-2.9V7h1.5v4.4z"/></symbol><use href="#ai:mdi:clock-time-four-outline"></use>  </svg> 7 min read </span> </div>  <img src="/_astro/cover.3KOyfXxm_Z1WEHIs.webp" alt="GraphQL in Scala: Role-Based Access Control" loading="lazy" decoding="async" fetchpriority="auto" width="853" height="480" class="rounded-lg mb-8">  </div> <div class="prose prose-neutral prose-lg md:prose-xl dark:prose-invert prose-img:rounded-xl prose-figure:text-center prose-img:mx-auto">  <p>Today, I’m going to answer a question asked <a href="https://x.com/lukasz_bialy/status/1796551094543516058">by Łukasz Biały on Twitter</a>:</p>
<blockquote>
<p>Is there a way to get field-level RBAC (Role-Based Access Control)?</p>
</blockquote>
<p>It turns out there is! However, Caliban’s approach to authentication and authorization is quite flexible. Instead of enforcing a specific method, Caliban provides tools that you can use to implement access control according to your needs. In this article, we’ll go through a complete example that you can reuse or draw inspiration from.</p>
<h3 id="the-problem">The problem</h3>
<p>Let’s imagine we have a very basic GraphQL schema:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="graphql"><code><span class="line"><span style="color:#F97583">type</span><span style="color:#79B8FF"> Query</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#FFAB70">  adminData</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">String</span><span style="color:#F97583">!</span><span style="color:#6A737D"> # requires Admin role</span></span>
<span class="line"><span style="color:#FFAB70">  userData</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">String</span><span style="color:#F97583">!</span><span style="color:#6A737D">  # requires User role</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>What we want to achieve with Role-Based Access Control is to ensure that clients can only access <code>adminData</code> if they have the <code>Admin</code> role and can only access <code>userData</code> if they have the <code>User</code> role. Any attempt to request a field without the required role should result in an execution error.</p>
<p>We will tackle this problem in three steps:</p>
<ol>
<li>
<p><strong>Tagging our schema</strong>: First, we will define our schema with Caliban and specify which role(s) are required for each field.</p>
</li>
<li>
<p><strong>Verifying permissions</strong>: Next, we will implement the logic to check during query execution whether each field is allowed to be requested or not.</p>
</li>
<li>
<p><strong>Providing the auth context</strong>: Finally, we will see how to extract role information from incoming requests and use it in our execution logic.</p>
</li>
</ol>
<h3 id="tagging-our-schema">Tagging our schema</h3>
<p>Let’s start by creating our schema with Caliban. If you’re not familiar with this, check out my <a href="https://blog.pierre-ricadat.com/a-beginners-guide-to-graphql-in-scala">Beginner’s Guide to GraphQL in Scala</a>.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="scala"><code><span class="line"><span style="color:#F97583">case</span><span style="color:#F97583"> class</span><span style="color:#B392F0"> Query</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#FFAB70">    adminData</span><span style="color:#E1E4E8">: </span><span style="color:#B392F0">String</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#FFAB70">    userData</span><span style="color:#E1E4E8">: </span><span style="color:#B392F0">String</span></span>
<span class="line"><span style="color:#E1E4E8">) </span><span style="color:#F97583">derives</span><span style="color:#B392F0"> Schema</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">SemiAuto</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">val</span><span style="color:#FFAB70"> api</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> graphQL(</span><span style="color:#B392F0">RootResolver</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">Query</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"admin"</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">"user"</span><span style="color:#E1E4E8">)))</span></span></code></pre>
<p>A quick call to <code>println(api.render)</code> allows us to verify that this produces the expected schema. Let’s also create our two roles:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="scala"><code><span class="line"><span style="color:#F97583">enum</span><span style="color:#B392F0"> Role</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">  case</span><span style="color:#B392F0"> Admin</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">User</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>Now, how do we define which role is required for each field? We will use GraphQL schema directives. Directives are a great way to add arbitrary data to our schema and access it during execution.</p>
<p>Caliban provides a <code>@GQLDirective</code> annotation that can be used on types and fields. Let’s create a more specific version of this annotation to make a <code>hasRole</code> directive. This directive will have a single property, <code>role</code>, which will specify the required role.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="scala"><code><span class="line"><span style="color:#F97583">val</span><span style="color:#FFAB70"> directiveName</span><span style="color:#F97583"> =</span><span style="color:#9ECBFF"> "hasRole"</span></span>
<span class="line"><span style="color:#F97583">val</span><span style="color:#FFAB70"> attributeName</span><span style="color:#F97583"> =</span><span style="color:#9ECBFF"> "role"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">class</span><span style="color:#B392F0"> HasRoleDirective</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">role</span><span style="color:#E1E4E8">: </span><span style="color:#B392F0">Role</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">  extends</span><span style="color:#B392F0"> GQLDirective</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#B392F0">            Directive</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#E1E4E8">              directiveName,</span></span>
<span class="line"><span style="color:#B392F0">              Map</span><span style="color:#E1E4E8">(attributeName </span><span style="color:#F97583">-></span><span style="color:#B392F0"> StringValue</span><span style="color:#E1E4E8">(role.toString))</span></span>
<span class="line"><span style="color:#E1E4E8">            )</span></span>
<span class="line"><span style="color:#E1E4E8">          )</span></span></code></pre>
<p>I extracted <code>directiveName</code> and <code>attributeName</code> into variables because we will need them later when we read those directives.</p>
<p>Once we have this annotation, we can create even more specific annotations to tag fields directly with their exact roles.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="scala"><code><span class="line"><span style="color:#F97583">case</span><span style="color:#F97583"> class</span><span style="color:#B392F0"> admin</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">extends</span><span style="color:#B392F0"> HasRoleDirective</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">Role</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Admin</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">case</span><span style="color:#F97583"> class</span><span style="color:#B392F0"> user</span><span style="color:#E1E4E8">()  </span><span style="color:#F97583">extends</span><span style="color:#B392F0"> HasRoleDirective</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">Role</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">User</span><span style="color:#E1E4E8">)</span></span></code></pre>
<p>This can then be used when we declare the schema:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="scala"><code><span class="line"><span style="color:#F97583">case</span><span style="color:#F97583"> class</span><span style="color:#B392F0"> Query</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#F97583">    @</span><span style="color:#E1E4E8">admin </span><span style="color:#FFAB70">adminData</span><span style="color:#E1E4E8">: </span><span style="color:#B392F0">String</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#F97583">    @</span><span style="color:#E1E4E8">user </span><span style="color:#FFAB70">userData</span><span style="color:#E1E4E8">: </span><span style="color:#B392F0">String</span></span>
<span class="line"><span style="color:#E1E4E8">) </span><span style="color:#F97583">derives</span><span style="color:#B392F0"> Schema</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">SemiAuto</span></span></code></pre>
<p>Calling <code>api.render</code> again, we see the directive appear in the generated schema:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="scala"><code><span class="line"><span style="color:#F97583">type</span><span style="color:#B392F0"> Query</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#FFAB70">  adminData</span><span style="color:#E1E4E8">: </span><span style="color:#B392F0">String</span><span style="color:#F97583">!</span><span style="color:#F97583"> @</span><span style="color:#E1E4E8">hasRole(</span><span style="color:#FFAB70">role</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"Admin"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#FFAB70">  userData</span><span style="color:#E1E4E8">: </span><span style="color:#B392F0">String</span><span style="color:#F97583">!</span><span style="color:#F97583"> @</span><span style="color:#E1E4E8">hasRole(</span><span style="color:#FFAB70">role</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"User"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>Great, we now have a simple and minimalist way to mark fields with required roles. This is done at the schema level and does not require any changes to our resolvers. Let’s see how we can use this.</p>
<h3 id="verifying-permissions">Verifying permissions</h3>
<p>To implement the verification logic, we will use the concept of <code>FieldWrapper</code>. A <code>FieldWrapper</code> is a piece of logic that runs every time a field is resolved. It provides the original execution computation and a <code>FieldInfo</code> value containing information about the field (its type and, importantly for us, its directives). You can run any code, potentially fail, or just run the original computation.</p>
<p>First, let’s implement a function that extracts our roles from the <code>FieldInfo</code> we receive.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="scala"><code><span class="line"><span style="color:#F97583">def</span><span style="color:#B392F0"> getRequiredRoles</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">info</span><span style="color:#E1E4E8">: </span><span style="color:#B392F0">FieldInfo</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Set</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">Role</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">=</span></span>
<span class="line"><span style="color:#E1E4E8">  info.directives</span></span>
<span class="line"><span style="color:#E1E4E8">    .filter(_.name </span><span style="color:#F97583">==</span><span style="color:#E1E4E8"> directiveName)</span></span>
<span class="line"><span style="color:#E1E4E8">    .flatMap(_.arguments.get(attributeName))</span></span>
<span class="line"><span style="color:#E1E4E8">    .flatMap {</span></span>
<span class="line"><span style="color:#F97583">      case</span><span style="color:#B392F0"> StringValue</span><span style="color:#E1E4E8">(role) </span><span style="color:#F97583">=></span><span style="color:#B392F0"> Try</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">Role</span><span style="color:#E1E4E8">.valueOf(role)).toOption.toList</span></span>
<span class="line"><span style="color:#F97583">      case</span><span style="color:#E1E4E8"> _                 </span><span style="color:#F97583">=></span><span style="color:#B392F0"> Nil</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">    .toSet</span></span></code></pre>
<p>It is quite straightforward: we get all directives matching our <code>directiveName</code>, read their <code>role</code> attribute, and transform all of that into a <code>Set[Role]</code>.</p>
<p>Next, to compare these required roles with the actual roles of the current user, we need an authorization context that contains these roles. Let’s call it <code>AuthContext</code>.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="scala"><code><span class="line"><span style="color:#F97583">case</span><span style="color:#F97583"> class</span><span style="color:#B392F0"> AuthContext</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">roles</span><span style="color:#E1E4E8">: </span><span style="color:#B392F0">Set</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">Role</span><span style="color:#E1E4E8">])</span></span></code></pre>
<p>We can now implement our <code>FieldWrapper</code>.</p>
<p>It will access <code>AuthContext</code> in the ZIO environment and check if any required roles are missing. If no roles are missing, we run the original computation <code>query</code>. If roles are missing, we fail with an error that tells us which roles are missing.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="scala"><code><span class="line"><span style="color:#F97583">val</span><span style="color:#FFAB70"> accessControl</span><span style="color:#F97583">:</span><span style="color:#B392F0"> FieldWrapper</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">AuthContext</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">=</span></span>
<span class="line"><span style="color:#F97583">  new</span><span style="color:#B392F0"> FieldWrapper</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">AuthContext</span><span style="color:#E1E4E8">](wrapPureValues </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> true</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">    def</span><span style="color:#B392F0"> wrap</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">R1</span><span style="color:#F97583"> &#x3C;:</span><span style="color:#B392F0"> AuthContext</span><span style="color:#E1E4E8">](</span></span>
<span class="line"><span style="color:#FFAB70">        query</span><span style="color:#E1E4E8">: </span><span style="color:#B392F0">ZQuery</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">R1</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">ExecutionError</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">ResponseValue</span><span style="color:#E1E4E8">],</span></span>
<span class="line"><span style="color:#FFAB70">        info</span><span style="color:#E1E4E8">: </span><span style="color:#B392F0">FieldInfo</span></span>
<span class="line"><span style="color:#E1E4E8">    )</span><span style="color:#F97583">:</span><span style="color:#B392F0"> ZQuery</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">R1</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">ExecutionError</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">ResponseValue</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">=</span></span>
<span class="line"><span style="color:#B392F0">      ZQuery</span><span style="color:#E1E4E8">.serviceWithQuery[</span><span style="color:#B392F0">AuthContext</span><span style="color:#E1E4E8">] { ctx </span><span style="color:#F97583">=></span></span>
<span class="line"><span style="color:#F97583">        val</span><span style="color:#FFAB70"> missingRoles</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> getRequiredRoles(info).diff(ctx.roles)</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> (missingRoles.isEmpty) query</span></span>
<span class="line"><span style="color:#F97583">        else</span><span style="color:#B392F0"> ZQuery</span><span style="color:#E1E4E8">.fail(</span><span style="color:#B392F0">ExecutionError</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">s</span><span style="color:#9ECBFF">"Missing required roles: </span><span style="color:#E1E4E8">${missingRoles.mkString(</span><span style="color:#9ECBFF">", "</span><span style="color:#E1E4E8">)}</span><span style="color:#9ECBFF">."</span><span style="color:#E1E4E8">))</span></span>
<span class="line"><span style="color:#E1E4E8">      }</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span></code></pre>
<p>Note that the field computation effect is <code>ZQuery</code>, not <code>ZIO</code>. This means that if your field wrapper needs to access a database, it can benefit from the optimizations that <code>ZQuery</code> provides, such as caching, deduplication, and batching.</p>
<p>You may have also noticed that we used <code>wrapPureValues = true</code>. This setting decides whether to run this logic on fields that don’t need any effects to execute. In this case, we want to wrap all fields because each field may have different permissions. If your schema is clearly divided at the top level between admin fields and user fields, and everything under these inherits their parent permissions, you may not need to wrap pure values (which will slightly improve performance).</p>
<p>We can then apply our wrapper to our API using <code>@@</code>.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="scala"><code><span class="line"><span style="color:#F97583">val</span><span style="color:#FFAB70"> api</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> graphQL(</span><span style="color:#B392F0">RootResolver</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">Query</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"admin"</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">"user"</span><span style="color:#E1E4E8">)))</span></span>
<span class="line"><span style="color:#F97583">            @@</span><span style="color:#E1E4E8"> accessControl</span></span></code></pre>
<p>Adding this wrapper changes the type of <code>api</code>. Previously, it was <code>GraphQL[Any]</code>, but now it is <code>GraphQL[AuthContext]</code>. This means we need to provide an <code>AuthContext</code> to run a GraphQL request. Let’s see how.</p>
<h3 id="providing-the-auth-context">Providing the auth context</h3>
<p>To expose our server, we are going to use the <code>caliban-quick</code> module which is the simplest and fastest solution and is based on <code>zio-http</code>. Similar implementations can be done if you use other server libraries such as <code>http4s</code> or <code>pekko-http</code>.</p>
<p>The <code>zio-http</code> library has the concept of <code>Middleware</code> that can be used to run some code on each request and potentially fail or provide some value to downstream code. That is exactly what <code>customAuthProviding</code> is doing: given an incoming request, you can either fail or return some context that will be provided as part of the ZIO environment of your request handler.</p>
<p>We’re going to use it with our <code>AuthContext</code>: we are checking if there is a <code>Roles</code> header in the incoming request, and if there is, we use it to build <code>AuthContext</code>. Note that we wouldn’t do it this way in a real-life scenario; instead, we would get a token from the headers, validate that token, and get the user roles from some kind of backend. But the implementation of this middleware would more or less be the same.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="scala"><code><span class="line"><span style="color:#F97583">val</span><span style="color:#FFAB70"> middleware</span><span style="color:#F97583"> =</span></span>
<span class="line"><span style="color:#B392F0">  Middleware</span><span style="color:#E1E4E8">.customAuthProviding[</span><span style="color:#B392F0">AuthContext</span><span style="color:#E1E4E8">] { req </span><span style="color:#F97583">=></span></span>
<span class="line"><span style="color:#E1E4E8">    req.headers</span></span>
<span class="line"><span style="color:#E1E4E8">      .get(</span><span style="color:#9ECBFF">"Roles"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">      .map(_.split(</span><span style="color:#9ECBFF">","</span><span style="color:#E1E4E8">).flatMap(s </span><span style="color:#F97583">=></span><span style="color:#B392F0"> Try</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">Role</span><span style="color:#E1E4E8">.valueOf(s)).toOption).toSet)</span></span>
<span class="line"><span style="color:#E1E4E8">      .map(roles </span><span style="color:#F97583">=></span><span style="color:#B392F0"> AuthContext</span><span style="color:#E1E4E8">(roles))</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span></code></pre>
<p>The rest of the code is straightforward: we convert our <code>GraphQL</code> object into a route with the path <code>api/graphql</code>, apply our middleware (using <code>@@</code>), and run everything on port 8080.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="scala"><code><span class="line"><span style="color:#B392F0">Unsafe</span><span style="color:#E1E4E8">.unsafely {</span></span>
<span class="line"><span style="color:#B392F0">  Runtime</span><span style="color:#E1E4E8">.default.unsafe.run {</span></span>
<span class="line"><span style="color:#E1E4E8">    api</span></span>
<span class="line"><span style="color:#E1E4E8">      .routes(</span><span style="color:#9ECBFF">"api/graphql"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">      .map(_ </span><span style="color:#F97583">@@</span><span style="color:#E1E4E8"> middleware)</span></span>
<span class="line"><span style="color:#E1E4E8">      .flatMap(_.serve.provideLayer(</span><span style="color:#B392F0">Server</span><span style="color:#E1E4E8">.defaultWithPort(</span><span style="color:#79B8FF">8080</span><span style="color:#E1E4E8">)))</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>We can now test our API. Let’s say our <code>Roles</code> header is <code>Roles: User</code>. If we call <code>query { adminData userData }</code>, we will get the following error:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="json"><code><span class="line"><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#79B8FF">  "data"</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">null</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#79B8FF">  "errors"</span><span style="color:#E1E4E8">: [</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#79B8FF">      "message"</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"Missing required roles: Admin."</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#79B8FF">      "locations"</span><span style="color:#E1E4E8">: [</span></span>
<span class="line"><span style="color:#E1E4E8">        {</span></span>
<span class="line"><span style="color:#79B8FF">          "line"</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#79B8FF">          "column"</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">9</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">      ],</span></span>
<span class="line"><span style="color:#79B8FF">      "path"</span><span style="color:#E1E4E8">: [</span></span>
<span class="line"><span style="color:#9ECBFF">        "adminData"</span></span>
<span class="line"><span style="color:#E1E4E8">      ]</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">  ]</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>Not only do we get an error as expected, but the error also tells us which field triggered the error and which role was missing. Neat!</p>
<p>On the other hand, if we run <code>query { userData }</code>, we get the expected result:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="json"><code><span class="line"><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#79B8FF">  "data"</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#79B8FF">    "userData"</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"user"</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<h3 id="conclusion">Conclusion</h3>
<p>That’s it for our example! We have shown how to implement role-based field access control using a custom directive to mark our fields, a field wrapper to run the verification logic, and an HTTP middleware to extract our auth context. These simple steps can be customized in many ways to fit your specific needs.</p>
<p>The complete code for this example can be found <a href="https://gist.github.com/ghostdogpr/f8dc3c33a3d2d85f6f8dfa1fb23ce1ab">in this Gist</a>.</p>
<p>You can run it directly with <a href="https://scala-cli.virtuslab.org/">Scala CLI</a> using this command:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#B392F0">scala-cli</span><span style="color:#9ECBFF"> https://gist.github.com/ghostdogpr/f8dc3c33a3d2d85f6f8dfa1fb23ce1ab</span></span></code></pre>  </div> </div> </div> </article> </main>  <footer> <div class="app-container grid md:grid-cols-3 gap-12 py-16 border-t-2 border-foreground/50 dark:border-foreground-dark/50"> <div> <a href="/" class="block w-fit" aria-label="Home"> <svg width="36" height="36" viewBox="0 0 36 36" fill="none">
  <rect width="36" height="36" rx="8" fill="currentColor" opacity="0.1" />
  <text x="18" y="25" font-family="system-ui, -apple-system, sans-serif" font-size="18" font-weight="700" fill="currentColor" text-anchor="middle">PR</text>
</svg> </a> </div> <div> <h3 class="font-semibold text-2xl">Links</h3> <div class="flex flex-wrap gap-4 mt-4"> <a class="text-lg" href target="_blank" rel="noopener noreferrer"> Blog </a><a class="text-lg" href="https://github.com/sponsors/ghostdogpr" target="_blank" rel="noopener noreferrer"> Sponsor </a> <a href="rss.xml" target="_blank" rel="noopener noreferrer" class="text-lg" aria-label="RSS Feed"> <svg width="1em" height="1em" class="w-6 h-6" data-icon="mdi:rss">   <symbol id="ai:mdi:rss" viewBox="0 0 24 24"><path fill="currentColor" d="M6.18 15.64a2.18 2.18 0 0 1 2.18 2.18C8.36 19 7.38 20 6.18 20C5 20 4 19 4 17.82a2.18 2.18 0 0 1 2.18-2.18M4 4.44A15.56 15.56 0 0 1 19.56 20h-2.83A12.73 12.73 0 0 0 4 7.27zm0 5.66a9.9 9.9 0 0 1 9.9 9.9h-2.83A7.07 7.07 0 0 0 4 12.93z"/></symbol><use href="#ai:mdi:rss"></use>  </svg> </a> </div> </div> <div> <h3 class="font-semibold text-2xl">Socials</h3> <div class="flex flex-wrap gap-4 mt-4"> <a class="text-lg" href="https://github.com/ghostdogpr" target="_blank" rel="noopener noreferrer"> GitHub </a><a class="text-lg" href="https://www.linkedin.com/in/pierrericadat/" target="_blank" rel="noopener noreferrer"> LinkedIn </a><a class="text-lg" href="https://twitter.com/ghostdogpr" target="_blank" rel="noopener noreferrer"> X / Twitter </a> </div> </div> </div> <div class="app-container flex justify-between items-center pb-6 text-center"> <p class="text-left md:text-center w-full">
Theme: <a class="underline" href="https://github.com/yashjawale/saral-theme-astro" target="_blank">Saral</a> </p> </div> </footer> </body></html>